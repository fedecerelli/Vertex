<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vertex - Sistema Integral de Gestión para Comercios</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, addDoc, setDoc, updateDoc, deleteDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales de Firebase (se inicializarán en DOMContentLoaded)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Proporcionado por el entorno Canvas

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // Autenticar usuario
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }

                // Escuchar cambios en el estado de autenticación para establecer userId e iniciar listeners de datos
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Firebase autenticado. ID de usuario:", window.userId);
                        // Ahora que el usuario está autenticado, configurar los listeners de Firestore
                        setupFirestoreListeners();
                        // Carga inicial de datos y actualizaciones de la interfaz de usuario
                        initApp();
                    } else {
                        window.userId = null;
                        console.log("Firebase: Ningún usuario ha iniciado sesión.");
                        // Manejar el estado de cierre de sesión, por ejemplo, limpiar datos, mostrar inicio de sesión
                        // Para esta aplicación, continuaremos con datos vacíos si no hay usuario
                        initApp();
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                // Fallback a almacenamiento local si Firebase falla al inicializar
                window.db = null;
                window.auth = null;
                window.userId = 'local-user'; // Simular un ID de usuario local para el fallback de localStorage
                console.warn("La inicialización de Firebase falló, recurriendo al almacenamiento local para la persistencia de datos.");
                initApp(); // Continuar con la inicialización de la aplicación usando localStorage
            }
        });
    </script>
    <script>
        // Configuración de Tailwind CSS para colores personalizados (Paleta "Deep Ocean & Aqua")
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Nueva Paleta: Deep Ocean & Aqua (Minimalista, Profesional, Tendencias 2025)
                        'primary-accent': '#4A47A3', // Un azul-púrpura profundo y rico
                        'secondary-accent': '#00C4B4', // Un aqua brillante y vibrante
                        'bg-lightest': '#F5F7FA', // Off-white muy claro
                        'bg-light': '#E0E6EF', // Gris-azul claro para tarjetas
                        'border-gray': '#C0C7D1', // Gris-azul sutil para bordes
                        'text-dark': '#2C3E50', // Carbón azul oscuro para texto principal
                        'text-secondary': '#7F8C8D', // Gris medio para texto secundario
                        // Colores para estados (hover/active)
                        'primary-hover': '#3B388E', // Tono más oscuro de primary-accent
                        'secondary-hover': '#00A59B', // Tono más oscuro de secondary-accent
                        'success-green': '#28A745', // Verde para mensajes de éxito
                        'error-red': '#DC3545', // Rojo para mensajes de error
                        'info-blue': '#17A2B8', // Azul para mensajes de información
                    }
                }
            }
        }
    </script>
    <style>
        /* Reset de estilos para asegurar consistencia en todos los navegadores */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Definición de variables CSS para colores, sombras, transiciones y efectos */
        :root {
            /* Colores adaptados de la paleta "Deep Ocean & Aqua" */
            --primary: #4A47A3;
            /* primary-accent */
            --surface: rgba(255, 255, 255, 0.08);
            /* Superficie translúcida */
            --surface-hover: rgba(255, 255, 255, 0.12);
            /* Superficie translúcida al pasar el ratón */
            --glass: rgba(74, 71, 163, 0.6);
            /* primary-accent con opacidad para glassmorphism */
            --glass-border: rgba(255, 255, 255, 0.2);
            /* Borde translúcido para el efecto glassmorphism */
            --text: #2C3E50;
            /* text-dark */
            --text-light: #ffffff;
            /* Color de texto claro */
            --text-secondary: #7F8C8D;
            /* text-secondary */
            --accent: #00C4B4;
            /* secondary-accent */
            --success: #28A745;
            /* success-green */
            --warning: #F59E0B;
            /* Tailwind orange-500 */
            --danger: #DC3545;
            /* error-red */
            --purple: #8B5CF6;
            /* Tailwind purple-500 */
            --pink: #EC4899;
            /* Tailwind pink-500 */
            --teal: #14B8A6;
            /* Tailwind teal-500 */
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.06);
            /* Sombra estándar */
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 16px rgba(0, 0, 0, 0.08);
            /* Sombra grande */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /* Transición suave estándar */
            --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
            /* Curva de transición elástica */
        }

        /* Estilos generales del cuerpo de la página */
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-dark);
            /* Color de texto por defecto para el cuerpo */
            overflow-x: hidden;
            display: flex;
            background-color: var(--bg-lightest);
            /* Usa el color de fondo de tu paleta */
            position: relative;
        }

        /* Oculta todos los módulos de contenido por defecto */
        .module-content {
            display: none;
        }

        /* Muestra solo el módulo que tiene la clase 'active' */
        .module-content.active {
            display: block;
        }

        /* Estilos personalizados para la barra de desplazamiento del área de contenido principal */
        .main-content-area::-webkit-scrollbar {
            width: 8px;
            /* Ancho de la barra de desplazamiento */
        }

        /* Pista de la barra de desplazamiento */
        .main-content-area::-webkit-scrollbar-track {
            background: #F3F4F6;
            /* Color de fondo de la pista (bg-light) */
            border-radius: 10px;
            /* Bordes redondeados para la pista */
        }

        /* Pulgar (el arrastrador) de la barra de desplazamiento */
        .main-content-area::-webkit-scrollbar-thumb {
            background: #9CA3AF;
            /* Un gris medio */
            border-radius: 10px;
            /* Bordes redondeados para el pulgar */
        }

        /* Color del pulgar al pasar el ratón por encima */
        .main-content-area::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
            /* Un tono más oscuro */
        }

        /* Ocultar barra de desplazamiento en la barra lateral secundaria (widget) */
        .secondary-sidebar-scrollable {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        .secondary-sidebar-scrollable::-webkit-scrollbar {
            display: none;
            /* Chrome, Safari, Opera */
        }

        /* Estilos para impresión (oculta elementos no deseados y centra el contenido) */
        @media print {
            body {
                margin: 0;
                padding: 0;
                overflow: visible !important;
                /* Permite que el contenido fluya para la impresión */
            }

            /* Oculta las barras laterales y otros elementos de navegación/interfaz */
            .nav-container,
            #secondarySidebar,
            header,
            .modal,
            #messageBox,
            #loadingSpinner,
            .flex.justify-between.items-center.mb-4.space-y-4.md\:space-y-0.md\:space-x-4,
            /* Controles de búsqueda/botón en módulos */
            .flex.justify-end.space-x-4,
            /* Botones de guardar/cancelar en modales */
            .dashboard-export-buttons,
            /* Contenedor de botones de exportación en dashboard */
            .table-controls

            /* Controles de tabla como paginación y ordenamiento */
                {
                display: none !important;
            }

            /* Muestra solo el contenido principal del módulo activo */
            main {
                width: 100% !important;
                margin: 0 auto !important;
                padding: 20px !important;
                box-shadow: none !important;
                display: block !important;
            }

            .module-content.active {
                display: block !important;
                width: 100% !important;
                box-shadow: none !important;
            }

            .module-content .bg-white.p-6.rounded-lg.shadow-sm {
                /* Se cambió a shadow-sm, pero mantenemos esta regla para impresión */
                box-shadow: none !important;
                border: none !important;
                padding: 0 !important;
            }

            /* Ajusta tablas para impresión */
            table {
                width: 100% !important;
                border-collapse: collapse;
            }

            th,
            td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }

            thead {
                background-color: #f2f2f2;
            }

            /* Oculta la columna de acciones en las tablas al imprimir */
            table th:last-child,
            table td:last-child {
                display: none;
            }
        }

        /* Responsive Table Layout for Mobile (Inventario Module) */
        @media (max-width: 767px) {

            /* Small screens (mobile) */
            #inventario-module table,
            #inventario-module thead,
            #inventario-module tbody,
            #inventario-module th,
            #inventario-module td,
            #inventario-module tr {
                display: block;
            }

            #inventario-module thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            #inventario-module tr {
                border: 1px solid #C0C7D1;
                /* border-gray */
                margin-bottom: 1rem;
                /* Adds space between "cards" */
                border-radius: 0.75rem;
                /* rounded-xl */
                overflow: hidden;
                /* Ensures rounded corners apply */
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                /* shadow-sm */
            }

            #inventario-module td {
                border: none;
                position: relative;
                padding-left: 50%;
                /* Make space for the label */
                text-align: right;
                padding-top: 0.75rem;
                /* py-3 */
                padding-bottom: 0.75rem;
                /* py-3 */
                padding-right: 1rem;
                /* px-4 */
                font-size: 0.875rem;
                /* text-sm */
            }

            #inventario-module td:before {
                position: absolute;
                left: 0;
                width: 45%;
                /* Adjust width for label */
                padding-left: 1rem;
                /* px-4 */
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                /* font-semibold */
                color: #7F8C8D;
                /* text-secondary */
                content: attr(data-label);
                /* Use data-label attribute for content */
            }

            /* Specific labels for each column in the Inventory table */
            #inventoryTableBody td:nth-of-type(1):before {
                content: "Código:";
            }

            #inventoryTableBody td:nth-of-type(2):before {
                content: "Nombre:";
            }

            #inventoryTableBody td:nth-of-type(3):before {
                content: "Costo Unitario:";
            }

            #inventoryTableBody td:nth-of-type(4):before {
                content: "Precio Sugerido:";
            }

            #inventoryTableBody td:nth-of-type(5):before {
                content: "Stock:";
            }

            #inventoryTableBody td:nth-of-type(6):before {
                content: "Categoría:";
            }

            #inventoryTableBody td:nth-of-type(7):before {
                content: "Acciones:";
            }

            /* Adjust actions column for mobile to center buttons */
            #inventoryTableBody td:nth-of-type(7) {
                text-align: center;
                padding-left: 1rem;
                /* Reset padding for actions */
            }

            #inventoryTableBody td:nth-of-type(7) .flex {
                justify-content: center;
                /* Center buttons */
            }
        }

        /* Estilos para el spinner de carga */
        #loadingSpinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
            /* Oculto por defecto */
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4A47A3;
            /* primary-accent */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Ajustes de diseño para expandir/contraer la barra lateral principal */
        @media (min-width: 768px) {
            body.sidebar-expanded .nav-container {
                width: 20rem;
                /* Ancho expandido (320px) */
            }

            body.sidebar-expanded #mainContentArea {
                margin-left: 20rem;
                /* Margen para el contenido principal */
            }

            body.sidebar-collapsed .nav-container {
                width: 5rem;
                /* Ancho contraído (80px) */
            }

            body.sidebar-collapsed #mainContentArea {
                margin-left: 5rem;
                /* Margen para el contenido principal */
            }

            #mainContentArea {
                /* Asegura que siempre ocupe el espacio restante y sea flexible */
                flex-grow: 1;
                flex-shrink: 1;
                flex-basis: 0;
                /* Permite que se encoja a 0 si es necesario, luego crezca */
                transition: margin-left 0.3s ease-out;
                /* Transición suave para el margen */
            }
        }

        /* Estilos de la barra de navegación */
        .nav-container {
            position: fixed;
            z-index: 1000;
            top: 0;
            /* Alinear arriba */
            left: 0;
            /* Alinear a la izquierda */
            height: 100vh;
            /* Altura completa de la ventana */
            padding: 1.5rem 0.5rem;
            /* Relleno para escritorio */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 5rem;
            /* Ancho contraído por defecto (80px) */
            transition: width 0.3s ease-out, padding 0.3s ease-out;
            /* Transición para el ancho */
        }

        @media (max-width: 768px) {
            .nav-container {
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                /* Restablecer arriba para móvil */
                height: auto;
                /* Restablecer altura para móvil */
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                width: 100%;
                padding: 1rem 0.5rem;
                border-radius: 0;
                /* Sin bordes redondeados en la barra inferior móvil */
                box-shadow: var(--shadow-lg);
                /* Aplicar glassmorphism directamente al nav-container en móvil */
                background: var(--glass);
                backdrop-filter: blur(30px) saturate(200%);
                border: 1px solid var(--glass-border);
            }
        }

        .navbar {
            /* En escritorio, el glassmorphism se aplica a .navbar */
            background: var(--glass);
            backdrop-filter: blur(30px) saturate(200%);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            border-radius: 40px;
            /* Bordes redondeados para la barra lateral de escritorio */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 0.5rem;
            width: 100%;
            /* Ocupar todo el ancho de nav-container */
            height: 100%;
            /* Ocupar toda la altura de nav-container */
            padding: 1.5rem 0.5rem;
            transition: var(--transition);
            /* Transición para el glassmorphism */
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: row;
                width: auto;
                height: auto;
                border-radius: 0;
                padding: 0;
                background: transparent;
                /* El fondo lo maneja nav-container en móvil */
                backdrop-filter: none;
                border: none;
                box-shadow: none;
            }
        }

        .navbar::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.15) 0%,
                    rgba(255, 255, 255, 0.05) 50%,
                    rgba(255, 255, 255, 0.02) 100%);
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .navbar::before {
                display: none;
                /* Sin brillo interno en la barra inferior móvil */
            }
        }

        .nav-item {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Centrar el icono por defecto */
            width: 3.5rem;
            /* Ancho fijo para el icono */
            height: 3.5rem;
            /* Altura fija para el icono */
            border: none;
            border-radius: 50%;
            background: transparent;
            cursor: pointer;
            transition: var(--transition);
            overflow: hidden;
            /* Ocultar el texto cuando está contraído */
            isolation: isolate;
            flex-shrink: 0;
            color: var(--text-light);
            /* Color de icono por defecto */
        }

        /* Oculta el botón de alternancia en dispositivos móviles */
        @media (max-width: 768px) {
            .toggle-btn {
                display: none;
            }

            .nav-item {
                width: 3.5rem;
                /* Mantener el tamaño del botón en móvil */
                height: 3.5rem;
            }

            .nav-item .nav-text {
                display: none;
                /* Ocultar texto en móvil */
            }
        }

        /* Estilos de los elementos de navegación cuando la barra está expandida en escritorio */
        body.sidebar-expanded .nav-item {
            width: 100%;
            /* Ocupar todo el ancho disponible */
            justify-content: flex-start;
            /* Alinear el contenido a la izquierda */
            padding: 0 1rem;
            /* Relleno para el texto */
            border-radius: 16px;
            /* Bordes redondeados para los elementos expandidos */
        }

        /* Pseudo-elemento para el fondo base (hover y estado normal) */
        .nav-item::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: calc(100% - 6px);
            /* Ancho ajustado */
            height: calc(100% - 6px);
            /* Altura ajustada */
            border-radius: 50%;
            /* Por defecto, circular */
            background: var(--surface);
            opacity: 0;
            transition: var(--transition);
            z-index: -1;
        }

        /* Ajuste del fondo para hover/normal cuando la barra está expandida (escritorio) */
        body.sidebar-expanded .nav-item::before {
            width: calc(100% - 6px);
            height: 48px;
            /* Altura para el fondo del elemento expandido */
            border-radius: 13px;
            /* Bordes redondeados para el fondo del elemento expandido */
        }

        /* Pseudo-elemento para el fondo del elemento activo */
        .nav-item::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: calc(100% - 6px);
            /* Ancho ajustado */
            height: calc(100% - 6px);
            /* Altura ajustada */
            border-radius: 50%;
            /* Por defecto, circular */
            background: var(--item-color);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: -2;
        }

        /* Ajuste del fondo para el elemento activo cuando la barra está expandida (escritorio) */
        body.sidebar-expanded .nav-item::after {
            width: calc(100% - 6px);
            height: 48px;
            /* Altura para el fondo del elemento activo expandido */
            border-radius: 13px;
            /* Bordes redondeados para el fondo del elemento activo expandido */
        }

        /* Estilos de los iconos de Font Awesome */
        .nav-item i {
            font-size: 1.2rem;
            color: var(--text-light);
            transition: var(--transition);
            position: relative;
            z-index: 1;
        }

        /* Estilos del texto de navegación */
        .nav-item .nav-text {
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: 500;
            margin-left: 12px;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            /* Asegurar que el texto no ocupe espacio cuando está oculto */
            position: absolute;
            /* Usar posición absoluta para no afectar el diseño del icono */
            left: 50%;
            /* Centrar inicialmente */
            transform: translateX(-50%) translateX(-10px);
            /* Ajustar para que el texto se mueva desde el centro */
            pointer-events: none;
            /* No interactuable cuando está oculto */
        }

        /* Muestra el texto cuando la barra está expandida (escritorio) */
        body.sidebar-expanded .nav-item .nav-text {
            opacity: 1;
            transform: translateX(0);
            /* Mover a la posición final */
            position: relative;
            /* Volver a posición normal para ocupar espacio */
            left: auto;
            /* Restablecer left */
            pointer-events: auto;
            /* Hacer interactuable */
        }

        /* Colores únicos para cada elemento de navegación (usando variables CSS) */
        /* Estos están mapeados a los colores de tu módulo */
        .nav-item[data-section="toggle"] {
            --item-color: var(--primary);
        }

        .nav-item[data-section="inventario"] {
            --item-color: var(--primary-accent);
        }

        .nav-item[data-section="compras"] {
            --item-color: var(--secondary-accent);
        }

        .nav-item[data-section="ventas"] {
            --item-color: #FF7F50;
            /* Color complementario */
        }

        .nav-item[data-section="dashboard"] {
            --item-color: #A34A47;
            /* Otro color complementario */
        }

        .nav-item[data-section="configuracion"] {
            --item-color: #6A5ACD;
            /* Púrpura medio */
        }

        /* Efectos al pasar el ratón (hover) */
        .nav-item:hover {
            transform: scale(1.05);
        }

        .nav-item:hover::before {
            opacity: 1;
        }

        .nav-item:hover i,
        .nav-item:hover .nav-text {
            color: var(--item-color);
            transform: scale(1.05);
        }

        /* Estado activo - fondo elegante con gradiente sutil y sombra */
        .nav-item.active::after {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            background: linear-gradient(135deg, var(--item-color), color-mix(in srgb, var(--item-color) 80%, white 20%));
            box-shadow: 0 4px 12px color-mix(in srgb, var(--item-color) 40%, transparent);
        }

        .nav-item.active i,
        .nav-item.active .nav-text {
            color: var(--text-light);
            transform: scale(1.05);
            font-weight: 600;
        }

        .nav-item.active::before {
            opacity: 0;
        }

        /* Efecto al hacer click/tocar */
        .nav-item:active {
            transform: scale(0.95);
        }

        /* Animación de pulso sutil en el fondo de hover */
        .nav-item:hover::before {
            animation: subtle-pulse 3s ease-in-out infinite;
        }

        @keyframes subtle-pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* Animaciones de entrada iniciales */
        .navbar {
            animation: navbar-enter 1.2s ease-out forwards;
        }

        .nav-item {
            animation: item-enter 1s ease-out both;
        }

        /* Retrasos para animaciones escalonadas de los elementos de navegación */
        .nav-item:nth-child(1) {
            animation-delay: 0.1s;
        }

        .nav-item:nth-child(2) {
            animation-delay: 0.2s;
        }

        .nav-item:nth-child(3) {
            animation-delay: 0.3s;
        }

        .nav-item:nth-child(4) {
            animation-delay: 0.4s;
        }

        .nav-item:nth-child(5) {
            animation-delay: 0.5s;
        }

        .nav-item:nth-child(6) {
            animation-delay: 0.6s;
        }

        /* Keyframes para la animación de entrada de la barra de navegación */
        @keyframes navbar-enter {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Keyframes para la animación de entrada de los elementos de navegación */
        @keyframes item-enter {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Ajustes para el contenido principal */
        #mainContentArea {
            padding: 1.5rem;
            /* Relleno ajustado */
            transition: margin-left 0.3s ease-out;
            /* Transición suave para el margen */
            height: 100vh;
            /* Altura completa de la ventana */
            overflow-y: auto;
            /* Habilitar desplazamiento para el contenido */
        }

        @media (max-width: 768px) {
            #mainContentArea {
                margin-left: 0 !important;
                /* Sin margen en móvil */
                padding-bottom: 5rem;
                /* Espacio para la barra de navegación inferior */
            }
        }

        /* Estilo para el encabezado principal */
        header {
            background-color: var(--bg-light);
            border: 1px solid var(--border-gray);
            box-shadow: var(--shadow-lg);
            /* Usar sombra grande para consistencia */
        }

        /* Estilo para la barra lateral secundaria */
        #secondarySidebar {
            background: linear-gradient(to bottom, var(--primary-accent), color-mix(in srgb, var(--primary-accent) 80%, black 20%));
            /* Gradiente consistente */
            box-shadow: var(--shadow-lg);
            /* Usar sombra grande para consistencia */
        }

        /* Estilo para los elementos internos de la barra lateral secundaria */
        #secondarySidebar .bg-gray-800 {
            background-color: color-mix(in srgb, var(--primary-accent) 15%, #2C3E50 85%);
            /* Un gris oscuro con un toque de primary-accent */
            box-shadow: var(--shadow);
            /* Sombra estándar para elementos internos */
        }

        #secondarySidebar .calc-btn.bg-gray-700 {
            background-color: color-mix(in srgb, var(--primary-accent) 10%, #2C3E50 90%);
            /* Un gris más oscuro para botones de calculadora */
        }

        #secondarySidebar .calc-btn.bg-gray-700:hover {
            background-color: color-mix(in srgb, var(--primary-accent) 20%, #2C3E50 80%);
        }

        #secondarySidebar .bg-gray-900 {
            background-color: color-mix(in srgb, var(--primary-accent) 5%, #2C3E50 95%);
            /* Fondo muy oscuro para inputs en sidebar */
        }
    </style>
</head>

<body class="bg-bg-lightest flex h-screen overflow-hidden font-inter text-text-dark sidebar-expanded">

    <div class="nav-container">
        <nav class="navbar">
            <button class="nav-item toggle-btn" data-section="toggle" aria-label="Alternar menú de navegación">
                <i class="fas fa-bars"></i>
                <span class="nav-text">Menú</span>
            </button>
            <button class="nav-item active" data-section="inventario" aria-label="Ir a Inventario">
                <i class="fas fa-box"></i>
                <span class="nav-text">Inventario</span>
            </button>
            <button class="nav-item" data-section="compras" aria-label="Ir a Compras">
                <i class="fas fa-shopping-cart"></i>
                <span class="nav-text">Compras</span>
            </button>
            <button class="nav-item" data-section="ventas" aria-label="Ir a Ventas">
                <i class="fas fa-cash-register"></i>
                <span class="nav-text">Ventas</span>
            </button>
            <button class="nav-item" data-section="dashboard" aria-label="Ir a Dashboard">
                <i class="fas fa-chart-line"></i>
                <span class="nav-text">Dashboard</span>
            </button>
            <button class="nav-item" data-section="configuracion" aria-label="Ir a Configuración">
                <i class="fas fa-cog"></i>
                <span class="nav-text">Configuración</span>
            </button>
        </nav>
    </div>

    <main id="mainContentArea" class="flex-1 flex flex-col p-6 overflow-y-auto main-content-area">
        <header
            class="flex justify-between items-center pb-4 border-b border-border-gray mb-4 bg-bg-light rounded-xl p-4">
            <h1 id="moduleTitle" class="text-3xl font-semibold text-text-dark">Inventario</h1>
            <button id="toggleSecondarySidebar"
                class="p-2 rounded-full bg-primary-accent text-white hover:bg-primary-hover transition-colors duration-200"
                aria-label="Alternar barra lateral de herramientas">
                <i class="fas fa-bars"></i> </button>
        </header>

        <section id="inventario-module" class="module-content active">
            <div class="bg-bg-light p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-text-dark">Gestión de Productos</h2>
                <div
                    class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-4 md:space-y-0 md:space-x-4">
                    <input type="text" id="productSearchInput"
                        placeholder="Buscar producto por código, nombre o descripción..."
                        class="p-3 border border-border-gray rounded-xl w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-primary-accent"
                        aria-label="Buscar producto">
                    <div class="flex space-x-2 w-full md:w-auto">
                        <button id="openNewProductModal"
                            class="bg-primary-accent text-white px-5 py-3 rounded-xl hover:bg-primary-hover transition-colors duration-200 shadow-md flex-1 md:flex-none">
                            <i class="fas fa-plus mr-2" aria-hidden="true"></i> Nuevo Producto
                        </button>
                        <button id="customizeColumnsBtn"
                            class="bg-text-secondary text-white px-3 py-3 rounded-xl hover:bg-gray-700 transition-colors duration-200 shadow-md"
                            title="Personalizar Columnas" aria-label="Personalizar columnas">
                            <i class="fas fa-columns" aria-hidden="true"></i>
                        </button>
                        <button id="printLabelsBtn"
                            class="bg-secondary-accent text-white px-3 py-3 rounded-xl hover:bg-secondary-hover transition-colors duration-200 shadow-md"
                            title="Imprimir Etiquetas" aria-label="Imprimir etiquetas">
                            <i class="fas fa-tags" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div
                    class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-bg-lightest rounded-xl border border-border-gray shadow-sm">
                    <div>
                        <label for="filterCategory"
                            class="block text-sm font-medium text-text-dark mb-1">Categoría:</label>
                        <select id="filterCategory"
                            class="p-2 border border-border-gray rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-label="Filtrar por categoría">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterPriceMin" class="block text-sm font-medium text-text-dark mb-1">Precio
                            Mínimo:</label>
                        <input type="number" id="filterPriceMin" placeholder="0.00"
                            class="p-2 border border-border-gray rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-label="Precio mínimo">
                    </div>
                    <div>
                        <label for="filterPriceMax" class="block text-sm font-medium text-text-dark mb-1">Precio
                            Máximo:</label>
                        <input type="number" id="filterPriceMax" placeholder="9999.99"
                            class="p-2 border border-border-gray rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-label="Precio máximo">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-bg-lightest border border-border-gray rounded-xl">
                        <thead class="bg-bg-light">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="code">Código <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="name">Nombre <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="unitCost">Costo Unitario <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="suggestedPrice">Precio Sugerido <i class="fas fa-sort text-xs ml-1"></i>
                                </th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="stock">Stock <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="category">Categoría <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th
                                    class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider">
                                    Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-4 table-controls">
                    <div id="paginationInfo" class="text-sm text-text-secondary"></div>
                    <div class="flex space-x-2">
                        <button id="prevPageBtn"
                            class="bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200"
                            aria-label="Página anterior">Anterior</button>
                        <button id="nextPageBtn"
                            class="bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200"
                            aria-label="Página siguiente">Siguiente</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="compras-module" class="module-content">
            <div class="bg-bg-light p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-text-dark">Gestión de Compras</h2>
                <div
                    class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-4 md:space-y-0 md:space-x-4">
                    <input type="text" id="purchaseSearchInput" placeholder="Buscar compra por proveedor o fecha..."
                        class="p-3 border border-border-gray rounded-xl w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-primary-accent"
                        aria-label="Buscar compra">
                    <button id="openNewPurchaseModal"
                        class="bg-primary-accent text-white px-5 py-3 rounded-xl hover:bg-primary-hover transition-colors duration-200 shadow-md w-full md:w-auto">
                        <i class="fas fa-plus mr-2" aria-hidden="true"></i> Nueva Compra
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-bg-lightest border border-border-gray rounded-xl">
                        <thead class="bg-bg-light">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="date">Fecha <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="supplier">Proveedor <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="total">Total <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th
                                    class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider">
                                    Ítems</th>
                                <th
                                    class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider">
                                    Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="purchasesTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-4 table-controls">
                    <div id="purchasePaginationInfo" class="text-sm text-text-secondary"></div>
                    <div class="flex space-x-2">
                        <button id="prevPurchasePageBtn"
                            class="bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200"
                            aria-label="Página anterior de compras">Anterior</button>
                        <button id="nextPurchasePageBtn"
                            class="bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200"
                            aria-label="Página siguiente de compras">Siguiente</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="ventas-module" class="module-content">
            <div class="bg-bg-light p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-text-dark">Gestión de Ventas</h2>
                <div
                    class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-4 md:space-y-0 md:space-x-4">
                    <input type="text" id="saleSearchInput" placeholder="Buscar venta por cliente o fecha..."
                        class="p-3 border border-border-gray rounded-xl w-full md:w-1/2 focus:outline-none focus:ring-2 focus:ring-primary-accent"
                        aria-label="Buscar venta">
                    <div class="flex space-x-2 w-full md:w-auto">
                        <button id="openNewSaleModal"
                            class="bg-primary-accent text-white px-5 py-3 rounded-xl hover:bg-primary-hover transition-colors duration-200 shadow-md flex-1 md:flex-none">
                            <i class="fas fa-plus mr-2" aria-hidden="true"></i> Nueva Venta
                        </button>
                        <button id="openNewReturnModal"
                            class="bg-secondary-accent text-white px-5 py-3 rounded-xl hover:bg-secondary-hover transition-colors duration-200 shadow-md flex-1 md:flex-none">
                            <i class="fas fa-undo mr-2" aria-hidden="true"></i> Nueva Devolución
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-bg-lightest border border-border-gray rounded-xl">
                        <thead class="bg-bg-light">
                            <tr>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="date">Fecha <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="client">Cliente <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider cursor-pointer sortable"
                                    data-sort="total">Total <i class="fas fa-sort text-xs ml-1"></i></th>
                                <th
                                    class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider">
                                    Ítems</th>
                                <th
                                    class="py-3 px-4 text-left text-sm font-medium text-text-secondary uppercase tracking-wider">
                                    Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center mt-4 table-controls">
                    <div id="salePaginationInfo" class="text-sm text-text-secondary"></div>
                    <div class="flex space-x-2">
                        <button id="prevSalePageBtn"
                            class="bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200"
                            aria-label="Página anterior de ventas">Anterior</button>
                        <button id="nextSalePageBtn"
                            class="bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200"
                            aria-label="Página siguiente de ventas">Siguiente</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="dashboard-module" class="module-content">
            <div class="bg-bg-light p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-text-dark">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-bg-lightest p-4 rounded-xl shadow-md border border-border-gray">
                        <h3 class="text-lg font-medium text-text-dark">Ventas del Día</h3>
                        <p class="text-3xl font-bold text-primary-accent" id="dailySales">$0.00</p>
                        <div class="flex items-center text-sm text-secondary-accent">
                            <i class="fas fa-arrow-up mr-1" aria-hidden="true"></i> 5% vs ayer
                        </div>
                    </div>
                    <div class="bg-bg-lightest p-4 rounded-xl shadow-md border border-border-gray">
                        <h3 class="text-lg font-medium text-text-dark">Compras del Mes</h3>
                        <p class="text-3xl font-bold text-secondary-accent" id="monthlyPurchases">$0.00</p>
                        <div class="flex items-center text-sm text-red-500">
                            <i class="fas fa-arrow-down mr-1" aria-hidden="true"></i> 2% vs mes anterior
                        </div>
                    </div>
                    <div class="bg-bg-lightest p-4 rounded-xl shadow-md border border-border-gray">
                        <h3 class="text-lg font-medium text-text-dark">Stock Valorizado</h3>
                        <p class="text-3xl font-bold text-primary-accent" id="stockValue">$0.00</p>
                    </div>
                    <div class="bg-bg-lightest p-4 rounded-xl shadow-md border border-border-gray">
                        <h3 class="text-lg font-medium text-text-dark">Margen Promedio</h3>
                        <p class="text-3xl font-bold text-secondary-accent" id="averageMargin">0%</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-bg-lightest p-4 rounded-xl shadow-md border border-border-gray">
                        <h3 class="text-lg font-medium text-text-dark mb-2">Gráfico de Ventas (últimos 6 meses)</h3>
                        <div class="h-64">
                            <canvas id="salesChart" role="img" aria-label="Gráfico de ventas mensuales"></canvas>
                        </div>
                    </div>
                    <div class="bg-bg-lightest p-4 rounded-xl shadow-md border border-border-gray">
                        <h3 class="text-lg font-medium text-text-dark mb-2">Ventas por Categoría de Producto</h3>
                        <div class="h-64 flex items-center justify-center">
                            <canvas id="categorySalesChart" role="img"
                                aria-label="Gráfico de ventas por categoría de producto"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-bg-lightest p-4 rounded-xl shadow-md border border-border-gray">
                        <h3 class="text-lg font-medium text-text-dark mb-2">Productos Más Vendidos</h3>
                        <ul id="topSellingProducts" class="list-disc list-inside text-text-dark">
                        </ul>
                    </div>
                    <div class="bg-bg-lightest p-4 rounded-xl shadow-md border border-border-gray">
                        <h3 class="text-lg font-medium text-text-dark mb-2">Productos con Bajo Stock</h3>
                        <ul id="lowStockProducts" class="list-disc list-inside text-text-dark">
                        </ul>
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-border-gray dashboard-export-buttons">
                    <h3 class="text-xl font-semibold mb-4 text-text-dark">Análisis y Reportes</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button
                            class="bg-blue-500 text-white px-5 py-3 rounded-xl hover:bg-blue-600 transition-colors duration-200 shadow-md"
                            onclick="showMessageBox('Análisis de Rentabilidad', 'Esta sección mostraría un análisis detallado de la rentabilidad por producto y categoría.', 'info')">
                            <i class="fas fa-chart-pie mr-2" aria-hidden="true"></i> Análisis de Rentabilidad
                        </button>
                        <button
                            class="bg-blue-500 text-white px-5 py-3 rounded-xl hover:bg-blue-600 transition-colors duration-200 shadow-md"
                            onclick="showMessageBox('Alertas de Stock', 'Aquí se mostraría una lista detallada de todos los productos con stock bajo o sobrestock.', 'info')">
                            <i class="fas fa-exclamation-triangle mr-2" aria-hidden="true"></i> Alertas de Stock
                        </button>
                        <button
                            class="bg-blue-500 text-white px-5 py-3 rounded-xl hover:bg-blue-600 transition-colors duration-200 shadow-md"
                            onclick="showMessageBox('Previsión', 'Esta sección mostraría proyecciones de ventas y necesidades de inventario basadas en datos históricos.', 'info')">
                            <i class="fas fa-chart-line mr-2" aria-hidden="true"></i> Previsión
                        </button>
                        <button id="exportInventoryCSV"
                            class="bg-secondary-accent text-white px-5 py-3 rounded-xl hover:bg-secondary-hover transition-colors duration-200 shadow-md">
                            <i class="fas fa-file-csv mr-2" aria-hidden="true"></i> Exportar Inventario (CSV)
                        </button>
                        <button id="printInventory"
                            class="bg-primary-accent text-white px-5 py-3 rounded-xl hover:bg-primary-hover transition-colors duration-200 shadow-md">
                            <i class="fas fa-print mr-2" aria-hidden="true"></i> Imprimir Inventario (A4)
                        </button>
                        <button id="exportSalesCSV"
                            class="bg-primary-accent text-white px-5 py-3 rounded-xl hover:bg-primary-hover transition-colors duration-200 shadow-md">
                            <i class="fas fa-file-csv mr-2" aria-hidden="true"></i> Exportar Ventas (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <section id="configuracion-module" class="module-content">
            <div class="bg-bg-light p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-text-dark">Configuración del Sistema</h2>
                <p class="text-text-dark">Aquí se gestionarán las configuraciones generales del sistema, como márgenes
                    de ganancia por defecto, umbrales de stock, etc.</p>
                <div class="mt-4">
                    <label for="defaultMargin" class="block text-sm font-medium text-text-dark">Margen de Ganancia por
                        Defecto (%):</label>
                    <input type="number" id="defaultMargin" value="50"
                        class="mt-1 p-2 border border-border-gray rounded-xl w-32 focus:outline-none focus:ring-2 focus:ring-primary-accent"
                        aria-label="Margen de ganancia por defecto">
                    <button id="saveDefaultMarginBtn"
                        class="ml-4 bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200">Guardar</button>
                </div>
                <div class="mt-4">
                    <label for="minStockThreshold" class="block text-sm font-medium text-text-dark">Umbral de Stock
                        Mínimo para Alerta:</label>
                    <input type="number" id="minStockThreshold" value="10"
                        class="mt-1 p-2 border border-border-gray rounded-xl w-32 focus:outline-none focus:ring-2 focus:ring-primary-accent"
                        aria-label="Umbral de stock mínimo para alerta">
                    <button id="saveMinStockThresholdBtn"
                        class="ml-4 bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200">Guardar</button>
                </div>
            </div>
        </section>

    </main>

    <aside id="secondarySidebar"
        class="w-64 bg-gradient-to-b from-primary-accent to-blue-950 text-white flex flex-col p-4 shadow-2xl transition-transform duration-700 ease-in-out transform translate-x-full fixed right-0 top-0 h-full z-50 rounded-l-xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-semibold">Herramientas</h2>
            <button id="closeSecondarySidebar"
                class="p-2 rounded-full text-text-secondary hover:text-white transition-colors duration-200"
                aria-label="Cerrar barra lateral de herramientas">
                <i class="fas fa-times"></i> </button>
        </div>
        <div class="flex-1 overflow-y-auto secondary-sidebar-scrollable">
            <div class="mb-6 bg-gray-800 p-3 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-2">
                    <button id="prevMonth"
                        class="p-2 rounded-full text-gray-300 hover:text-white transition-colors duration-200"
                        aria-label="Mes anterior"><i class="fas fa-chevron-left"></i></button>
                    <span id="currentMonthYear" class="font-semibold" aria-live="polite">Mayo 2025</span>
                    <button id="nextMonth"
                        class="p-2 rounded-full text-gray-300 hover:text-white transition-colors duration-200"
                        aria-label="Mes siguiente"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="calendarDays" class="grid grid-cols-7 gap-1 text-sm">
                    <div class="text-gray-400">Lun</div>
                    <div class="text-gray-400">Mar</div>
                    <div class="text-gray-400">Mié</div>
                    <div class="text-gray-400">Jue</div>
                    <div class="text-gray-400">Vie</div>
                    <div class="text-gray-400">Sáb</div>
                    <div class="py-1">Dom</div>
                </div>
            </div>
            <div class="mb-6 bg-gray-800 p-4 rounded-xl shadow-md">
                <input type="text" id="calculatorDisplay"
                    class="w-full p-2 mb-3 rounded-xl bg-gray-900 text-white text-right text-2xl font-bold focus:outline-none"
                    value="0" readonly aria-label="Pantalla de la calculadora">
                <div class="grid grid-cols-4 gap-2">
                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="C" aria-label="Borrar">C</button>
                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="/" aria-label="Dividir">/</button>
                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="*" aria-label="Multiplicar">*</button>
                    <button
                        class="calc-btn bg-primary-accent hover:bg-primary-hover transition-colors text-white rounded-xl py-3"
                        data-value="-" aria-label="Restar">-</button>

                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="7" aria-label="Siete">7</button>
                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="8" aria-label="Ocho">8</button>
                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="9" aria-label="Nueve">9</button>
                    <button
                        class="calc-btn bg-primary-accent hover:bg-primary-hover transition-colors text-white rounded-xl py-3"
                        data-value="+" aria-label="Sumar">+</button>

                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="4" aria-label="Cuatro">4</button>
                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="5" aria-label="Cinco">5</button>
                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="6" aria-label="Seis">6</button>
                    <button
                        class="calc-btn row-span-2 bg-secondary-accent hover:bg-secondary-hover transition-colors text-white rounded-xl py-3"
                        data-value="=" aria-label="Igual">=</button>

                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="1" aria-label="Uno">1</button>
                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="2" aria-label="Dos">2</button>
                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="3" aria-label="Tres">3</button>

                    <button
                        class="calc-btn col-span-2 bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="0" aria-label="Cero">0</button>
                    <button class="calc-btn bg-gray-700 hover:bg-gray-600 transition-colors text-white rounded-xl py-3"
                        data-value="." aria-label="Punto decimal">.</button>
                </div>
            </div>
            <div class="mb-6 bg-gray-800 p-3 rounded-xl shadow-md">
                <textarea id="notepad"
                    class="w-full h-32 p-3 rounded-xl bg-gray-900 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-accent"
                    placeholder="Escribe tus notas aquí..." aria-label="Anotador de notas"></textarea>
                <div class="flex justify-end mt-2 space-x-2">
                    <button id="saveNote"
                        class="bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200 text-sm">Guardar</button>
                    <button id="loadNote"
                        class="bg-text-secondary text-white px-4 py-2 rounded-xl hover:bg-gray-700 transition-colors duration-200 text-sm">Cargar</button>
                </div>
            </div>
            <div class="mb-6 bg-gray-800 p-3 rounded-xl shadow-md">
                <h4 class="font-semibold mb-2 text-white">Recordatorios</h4>
                <input type="text" id="newReminderInput" placeholder="Añadir nueva tarea..."
                    class="w-full p-2 mb-2 rounded-lg bg-gray-900 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-accent"
                    aria-label="Añadir nuevo recordatorio">
                <button id="addReminderBtn"
                    class="bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200 text-sm w-full">Añadir
                    Recordatorio</button>
                <ul id="reminderList" class="mt-3 space-y-2">
                </ul>
            </div>
            <div class="grid grid-cols-1 gap-4">
                <div class="bg-gray-800 p-4 rounded-xl text-white shadow-md">
                    <h4 class="font-semibold mb-2">Últimas Ventas</h4>
                    <ul id="recentSalesList" class="text-sm">
                    </ul>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl text-white shadow-md">
                    <h4 class="font-semibold mb-2">Productos con Bajo Stock</h4>
                    <ul id="lowStockWidgetList" class="text-sm">
                    </ul>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl text-white shadow-md">
                    <h4 class="font-semibold mb-2">Compras Recientes</h4>
                    <ul id="recentPurchasesList" class="text-sm">
                    </ul>
                </div>
            </div>
        </div>
    </aside>

    <div id="newProductModal"
        class="fixed inset-0 bg-text-dark bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-bg-lightest p-8 rounded-xl shadow-xl w-full max-w-2xl relative max-h-[90vh] overflow-y-auto">
            <button class="absolute top-4 right-4 text-text-secondary hover:text-text-dark text-xl close-modal"
                aria-label="Cerrar modal de nuevo producto">
                <i class="fas fa-times"></i> </button>
            <h2 class="text-2xl font-semibold mb-6 text-text-dark">Registrar Nuevo Producto</h2>
            <form id="newProductForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="productCode" class="block text-sm font-medium text-text-dark mb-1">Código de
                            Producto</label>
                        <input type="text" id="productCode"
                            class="p-3 border border-border-gray rounded-xl w-full bg-bg-light text-text-dark" readonly
                            aria-label="Código de producto generado automáticamente">
                    </div>
                    <div>
                        <label for="productName" class="block text-sm font-medium text-text-dark mb-1">Nombre de
                            Producto <span class="text-red-500">*</span></label>
                        <input type="text" id="productName" required
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            placeholder="Ej: Laptop Gamer X1" aria-required="true">
                    </div>
                </div>
                <div class="mb-4">
                    <label for="productDescription"
                        class="block text-sm font-medium text-text-dark mb-1">Descripción</label>
                    <textarea id="productDescription" rows="3"
                        class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                        placeholder="Descripción detallada del producto"
                        aria-label="Descripción del producto"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="unitCost" class="block text-sm font-medium text-text-dark mb-1">Costo
                            Unitario <span class="text-red-500">*</span></label>
                        <input type="number" id="unitCost" required min="0" step="0.01"
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            placeholder="0.00" aria-required="true" aria-label="Costo unitario del producto">
                    </div>
                    <div>
                        <label for="profitMargin" class="block text-sm font-medium text-text-dark mb-1">Margen de
                            Ganancia (%) <span class="text-red-500">*</span></label>
                        <input type="number" id="profitMargin" required min="0" step="0.01"
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            value="50" aria-required="true" aria-label="Margen de ganancia en porcentaje">
                    </div>
                    <div>
                        <label for="suggestedPrice" class="block text-sm font-medium text-text-dark mb-1">Precio de
                            Venta Sugerido</label>
                        <input type="text" id="suggestedPrice"
                            class="p-3 border border-border-border-gray rounded-xl w-full bg-bg-light text-text-dark"
                            readonly value="$0.00" aria-label="Precio de venta sugerido (calculado)">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="initialStock" class="block text-sm font-medium text-text-dark mb-1">Stock
                            Inicial <span class="text-red-500">*</span></label>
                        <input type="number" id="initialStock" required min="0"
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            placeholder="0" aria-required="true" aria-label="Stock inicial del producto">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-text-dark mb-1">Categoría <span
                                class="text-red-500">*</span></label>
                        <select id="category" required
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-required="true" aria-label="Categoría del producto">
                            <option value="">Seleccione una categoría</option>
                            <option value="electronica">Electrónica</option>
                            <option value="perifericos">Periféricos</option>
                            <option value="accesorios">Accesorios</option>
                            <option value="software">Software</option>
                            <option value="nueva-categoria">+ Nueva Categoría</option>
                        </select>
                    </div>
                    <div>
                        <label for="supplier" class="block text-sm font-medium text-text-dark mb-1">Proveedor
                            Principal</label>
                        <select id="supplier"
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-label="Proveedor principal del producto">
                            <option value="">Seleccione un proveedor</option>
                            <option value="tech-suppliers">Tech Suppliers S.A.</option>
                            <option value="global-dist">Global Distribuidores</option>
                            <option value="nuevo-proveedor">+ Nuevo Proveedor</option>
                        </select>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="productImage" class="block text-sm font-medium text-text-dark mb-1">Imagen del
                        Producto</label>
                    <input type="file" id="productImage" accept="image/*"
                        class="block w-full text-sm text-text-secondary file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-accent file:text-white hover:file:bg-primary-hover"
                        aria-label="Subir imagen del producto">
                    <div id="imagePreview"
                        class="mt-2 w-32 h-32 bg-bg-light rounded-xl flex items-center justify-center text-text-secondary overflow-hidden"
                        aria-label="Vista previa de la imagen del producto">
                        <i class="fas fa-image text-4xl" aria-hidden="true"></i>
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button"
                        class="bg-text-secondary text-white px-6 py-3 rounded-xl hover:bg-gray-700 transition-colors duration-200 close-modal">Cancelar</button>
                    <button type="submit"
                        class="bg-primary-accent text-white px-6 py-3 rounded-xl hover:bg-primary-hover transition-colors duration-200">Guardar
                        Producto</button>
                </div>
            </form>
        </div>
    </div>

    <div id="newPurchaseModal"
        class="fixed inset-0 bg-text-dark bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-bg-lightest p-8 rounded-xl shadow-xl w-full max-w-3xl relative max-h-[90vh] overflow-y-auto">
            <button class="absolute top-4 right-4 text-text-secondary hover:text-text-dark text-xl close-modal"
                aria-label="Cerrar modal de nueva compra">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-2xl font-semibold mb-6 text-text-dark">Registrar Nueva Compra</h2>
            <form id="newPurchaseForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="purchaseDate" class="block text-sm font-medium text-text-dark mb-1">Fecha de
                            Compra <span class="text-red-500">*</span></label>
                        <input type="date" id="purchaseDate" required
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-required="true" aria-label="Fecha de la compra">
                    </div>
                    <div>
                        <label for="purchaseSupplier" class="block text-sm font-medium text-text-dark mb-1">Proveedor
                            <span class="text-red-500">*</span></label>
                        <select id="purchaseSupplier" required
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-required="true" aria-label="Proveedor de la compra">
                            <option value="">Seleccione un proveedor</option>
                            <option value="tech-suppliers">Tech Suppliers S.A.</option>
                            <option value="global-dist">Global Distribuidores</option>
                            <option value="nuevo-proveedor">+ Nuevo Proveedor</option>
                        </select>
                    </div>
                </div>

                <h3 class="text-lg font-medium mb-3 text-text-dark">Detalle de Productos</h3>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                    <input type="text" id="productSearchPurchase" placeholder="Buscar producto por código o nombre..."
                        class="p-3 border border-border-gray rounded-xl flex-1 focus:outline-none focus:ring-2 focus:ring-primary-accent w-full"
                        aria-label="Buscar producto para añadir a la compra">
                    <button type="button" id="addProductToPurchase"
                        class="bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200 w-full sm:w-auto">Agregar
                        Producto</button>
                </div>

                <div class="overflow-x-auto mb-6">
                    <table id="purchaseProductsTable"
                        class="min-w-full bg-bg-lightest border border-border-gray rounded-xl">
                        <thead class="bg-bg-light">
                            <tr>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Nombre</th>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Código</th>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Cantidad</th>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Costo Unitario</th>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Subtotal</th>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end items-center text-xl font-semibold text-text-dark mb-6">
                    Total de la Compra: <span id="purchaseTotal" class="ml-2">$0.00</span>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button"
                        class="bg-text-secondary text-white px-6 py-3 rounded-xl hover:bg-gray-700 transition-colors duration-200 close-modal">Cancelar</button>
                    <button type="submit"
                        class="bg-primary-accent text-white px-6 py-3 rounded-xl hover:bg-primary-hover transition-colors duration-200">Guardar
                        Compra</button>
                </div>
            </form>
        </div>
    </div>

    <div id="newSaleModal"
        class="fixed inset-0 bg-text-dark bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-bg-lightest p-8 rounded-xl shadow-xl w-full max-w-3xl relative max-h-[90vh] overflow-y-auto">
            <button class="absolute top-4 right-4 text-text-secondary hover:text-text-dark text-xl close-modal"
                aria-label="Cerrar modal de nueva venta">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-2xl font-semibold mb-6 text-text-dark">Registrar Nueva Venta</h2>
            <form id="newSaleForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="saleDate" class="block text-sm font-medium text-text-dark mb-1">Fecha de
                            Venta <span class="text-red-500">*</span></label>
                        <input type="date" id="saleDate" required
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-required="true" aria-label="Fecha de la venta">
                    </div>
                    <div>
                        <label for="saleClient" class="block text-sm font-medium text-text-dark mb-1">Cliente
                            (Opcional)</label>
                        <input type="text" id="saleClient" list="clientList"
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            placeholder="Nombre del cliente" aria-label="Nombre del cliente">
                        <datalist id="clientList"></datalist>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="paymentMethod" class="block text-sm font-medium text-text-dark mb-1">Método de
                        Pago <span class="text-red-500">*</span></label>
                    <div class="flex items-center space-x-2">
                        <select id="paymentMethod" required
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-required="true" aria-label="Método de pago">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Mercado Pago">Mercado Pago</option>
                            <option value="Cuenta DNI">Cuenta DNI</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Debe">Debe</option>
                        </select>
                        <span id="debeIndicator" class="text-error-red font-semibold text-sm hidden"
                            aria-live="polite">¡Debe!</span>
                    </div>
                </div>

                <h3 class="text-lg font-medium mb-3 text-text-dark">Detalle de Productos</h3>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                    <input type="text" id="productSearchSale" placeholder="Buscar producto por código o nombre..."
                        class="p-3 border border-border-gray rounded-xl flex-1 focus:outline-none focus:ring-2 focus:ring-primary-accent w-full"
                        aria-label="Buscar producto para añadir a la venta">
                    <button type="button" id="addProductToSale"
                        class="bg-primary-accent text-white px-4 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200 w-full sm:w-auto">Agregar
                        Producto</button>
                </div>
                <div class="mb-4 p-3 bg-bg-light rounded-xl border border-border-gray">
                    <h4 class="text-sm font-semibold text-text-dark mb-2">Sugerencias de Productos Frecuentes:</h4>
                    <div id="frequentProductsSuggestions" class="flex flex-wrap gap-2">
                    </div>
                </div>

                <div class="overflow-x-auto mb-6">
                    <table id="saleProductsTable"
                        class="min-w-full bg-bg-lightest border border-border-gray rounded-xl">
                        <thead class="bg-bg-light">
                            <tr>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Nombre</th>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Código</th>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Cantidad</th>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Precio Sugerido</th>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Precio Final</th>
                                <th
                                    class="py-2 px-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                    Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end items-center text-xl font-semibold text-text-dark mb-6">
                    Total de la Venta: <span id="saleTotal" class="ml-2">$0.00</span>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button"
                        class="bg-text-secondary text-white px-6 py-3 rounded-xl hover:bg-gray-700 transition-colors duration-200 close-modal">Cancelar</button>
                    <button type="submit"
                        class="bg-primary-accent text-white px-6 py-3 rounded-xl hover:bg-primary-hover transition-colors duration-200">Registrar
                        Venta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="newReturnModal"
        class="fixed inset-0 bg-text-dark bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-bg-lightest p-8 rounded-xl shadow-xl w-full max-w-2xl relative max-h-[90vh] overflow-y-auto">
            <button class="absolute top-4 right-4 text-text-secondary hover:text-text-dark text-xl close-modal"
                aria-label="Cerrar modal de nueva devolución">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-2xl font-semibold mb-6 text-text-dark">Registrar Nueva Devolución</h2>
            <form id="newReturnForm">
                <div class="mb-4">
                    <label for="returnSaleId" class="block text-sm font-medium text-text-dark mb-1">ID de Venta
                        (Opcional)</label>
                    <input type="text" id="returnSaleId"
                        class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                        placeholder="Ej: VENTA-20250521-123" aria-label="ID de venta para la devolución">
                </div>
                <div class="mb-4">
                    <label for="returnProductName" class="block text-sm font-medium text-text-dark mb-1">Producto a
                        Devolver <span class="text-red-500">*</span></label>
                    <input type="text" id="returnProductName" required
                        class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                        placeholder="Nombre del producto" aria-required="true"
                        aria-label="Nombre del producto a devolver">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="returnQuantity" class="block text-sm font-medium text-text-dark mb-1">Cantidad <span
                                class="text-red-500">*</span></label>
                        <input type="number" id="returnQuantity" min="1" value="1" required
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-required="true" aria-label="Cantidad a devolver">
                    </div>
                    <div>
                        <label for="returnRefundAmount" class="block text-sm font-medium text-text-dark mb-1">Monto a
                            Reembolsar <span class="text-red-500">*</span></label>
                        <input type="number" id="returnRefundAmount" placeholder="0.00" required min="0" step="0.01"
                            class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                            aria-required="true" aria-label="Monto a reembolsar">
                    </div>
                </div>
                <div class="mb-6">
                    <label for="returnReason" class="block text-sm font-medium text-text-dark mb-1">Motivo de la
                        Devolución <span class="text-red-500">*</span></label>
                    <select id="returnReason" required
                        class="p-3 border border-border-gray rounded-xl w-full focus:outline-none focus:ring-2 focus:ring-primary-accent"
                        aria-required="true" aria-label="Motivo de la devolución">
                        <option value="">Seleccione un motivo</option>
                        <option value="defective">Producto defectuoso</option>
                        <option value="change_mind">Cambio de opinión</option>
                        <option value="wrong_size_color">Talla/Color incorrecto</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button"
                        class="bg-text-secondary text-white px-6 py-3 rounded-xl hover:bg-gray-700 transition-colors duration-200 close-modal">Cancelar</button>
                    <button type="submit"
                        class="bg-primary-accent text-white px-6 py-3 rounded-xl hover:bg-primary-hover transition-colors duration-200">Registrar
                        Devolución</button>
                </div>
            </form>
        </div>
    </div>

    <div id="messageBox"
        class="fixed inset-0 bg-text-dark bg-opacity-50 flex items-center justify-center z-[100] hidden">
        <div class="bg-bg-lightest p-6 rounded-xl shadow-xl max-w-sm w-full text-center relative">
            <h3 id="messageBoxTitle" class="text-xl font-semibold mb-3 text-text-dark"></h3>
            <p id="messageBoxContent" class="text-text-secondary mb-6"></p>
            <button id="messageBoxClose"
                class="bg-primary-accent text-white px-5 py-2 rounded-xl hover:bg-primary-hover transition-colors duration-200">Aceptar</button>
        </div>
    </div>

    <div id="loadingSpinner" class="hidden">
        <div class="spinner"></div>
    </div>

    <script type="module">
        // Importaciones de Firebase (ya están en el head, pero se repiten aquí para claridad del script principal)
        import { collection, query, onSnapshot, doc, addDoc, setDoc, updateDoc, deleteDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Arrays de datos globales (se poblarán mediante listeners de Firestore)
        let productsData = [];
        let purchasesData = [];
        let salesData = [];
        let clientsData = []; // Nuevo array para clientes

        // --- Elementos del DOM ---
        const navContainer = document.querySelector('.nav-container');
        const navbar = document.querySelector('.navbar');
        const navItems = document.querySelectorAll('.nav-item');
        const toggleButton = document.querySelector('.toggle-btn');
        const moduleContents = document.querySelectorAll('.module-content');
        const moduleTitle = document.getElementById('moduleTitle');
        const toggleSecondarySidebarBtn = document.getElementById('toggleSecondarySidebar');
        const secondarySidebar = document.getElementById('secondarySidebar');
        const closeSecondarySidebarBtn = document.getElementById('closeSecondarySidebar');
        const mainContentArea = document.getElementById('mainContentArea'); // Renombrado para mayor claridad

        const newProductModal = document.getElementById('newProductModal');
        const openNewProductModalBtn = document.getElementById('openNewProductModal');
        const newPurchaseModal = document.getElementById('newPurchaseModal');
        const openNewPurchaseModalBtn = document.getElementById('openNewPurchaseModal');
        const newSaleModal = document.getElementById('newSaleModal');
        const openNewSaleModalBtn = document.getElementById('openNewSaleModal');
        const newReturnModal = document.getElementById('newReturnModal');
        const openNewReturnModalBtn = document.getElementById('openNewReturnModal');
        const closeModalBtns = document.querySelectorAll('.close-modal');

        const newProductForm = document.getElementById('newProductForm');
        const productCodeInput = document.getElementById('productCode');
        const productNameInput = document.getElementById('productName');
        const productDescriptionInput = document.getElementById('productDescription');
        const unitCostInput = document.getElementById('unitCost');
        const profitMarginInput = document.getElementById('profitMargin');
        const suggestedPriceInput = document.getElementById('suggestedPrice');
        const initialStockInput = document.getElementById('initialStock');
        const categoryInput = document.getElementById('category');
        const supplierInput = document.getElementById('supplier');
        const productImageInput = document.getElementById('productImage');
        const imagePreview = document.getElementById('imagePreview');

        const notepad = document.getElementById('notepad');
        const saveNoteBtn = document.getElementById('saveNote');
        const loadNoteBtn = document.getElementById('loadNote');
        const newReminderInput = document.getElementById('newReminderInput');
        const addReminderBtn = document.getElementById('addReminderBtn');
        const reminderList = document.getElementById('reminderList');

        const calculatorDisplay = document.getElementById('calculatorDisplay');
        const calculatorButtons = document.querySelectorAll('.calc-btn');

        const messageBox = document.getElementById('messageBox');
        const messageBoxTitle = document.getElementById('messageBoxTitle');
        const messageBoxContent = document.getElementById('messageBoxContent');
        const messageBoxClose = document.getElementById('messageBoxClose');

        const exportInventoryCSVBtn = document.getElementById('exportInventoryCSV');
        const printInventoryBtn = document.getElementById('printInventory');
        const exportSalesCSVBtn = document.getElementById('exportSalesCSV');
        const inventoryTableBody = document.getElementById('inventoryTableBody');
        const customizeColumnsBtn = document.getElementById('customizeColumnsBtn');
        const printLabelsBtn = document.getElementById('printLabelsBtn');
        const minStockThresholdInput = document.getElementById('minStockThreshold');
        const saveDefaultMarginBtn = document.getElementById('saveDefaultMarginBtn');
        const saveMinStockThresholdBtn = document.getElementById('saveMinStockThresholdBtn');
        const defaultMarginInput = document.getElementById('defaultMargin');


        const addProductToSaleBtn = document.getElementById('addProductToSale');
        const productSearchSaleInput = document.getElementById('productSearchSale');
        const saleProductsTableBody = document.querySelector('#saleProductsTable tbody');
        const saleTotalSpan = document.getElementById('saleTotal');
        const paymentMethodSelect = document.getElementById('paymentMethod');
        const debeIndicator = document.getElementById('debeIndicator');
        const saleClientInput = document.getElementById('saleClient');
        const clientDatalist = document.getElementById('clientList');
        const frequentProductsSuggestions = document.getElementById('frequentProductsSuggestions');

        // Elementos de la tabla de inventario para filtros y paginación
        const productSearchInput = document.getElementById('productSearchInput');
        const filterCategorySelect = document.getElementById('filterCategory');
        const filterPriceMinInput = document.getElementById('filterPriceMin');
        const filterPriceMaxInput = document.getElementById('filterPriceMax');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');
        const paginationInfo = document.getElementById('paginationInfo');
        const inventoryTableHeaders = document.querySelectorAll('#inventario-module th.sortable');

        // Elementos de la tabla de compras
        const purchaseSearchInput = document.getElementById('purchaseSearchInput');
        const purchasesTableBody = document.getElementById('purchasesTableBody');
        const prevPurchasePageBtn = document.getElementById('prevPurchasePageBtn');
        const nextPurchasePageBtn = document.getElementById('nextPurchasePageBtn');
        const purchasePaginationInfo = document.getElementById('purchasePaginationInfo');
        const purchaseTableHeaders = document.querySelectorAll('#compras-module th.sortable');

        // Elementos de la tabla de ventas
        const saleSearchInput = document.getElementById('saleSearchInput');
        const salesTableBody = document.getElementById('salesTableBody');
        const prevSalePageBtn = document.getElementById('prevSalePageBtn');
        const nextSalePageBtn = document.getElementById('nextSalePageBtn');
        const salePaginationInfo = document.getElementById('salePaginationInfo');
        const saleTableHeaders = document.querySelectorAll('#ventas-module th.sortable');

        // Elementos del Dashboard
        const dailySalesSpan = document.getElementById('dailySales');
        const monthlyPurchasesSpan = document.getElementById('monthlyPurchases');
        const stockValueSpan = document.getElementById('stockValue');
        const averageMarginSpan = document.getElementById('averageMargin');
        const salesChartCanvas = document.getElementById('salesChart');
        const categorySalesChartCanvas = document.getElementById('categorySalesChart');
        const topSellingProductsList = document.getElementById('topSellingProducts');
        const lowStockProductsList = document.getElementById('lowStockProducts');
        const recentSalesList = document.getElementById('recentSalesList');
        const lowStockWidgetList = document.getElementById('lowStockWidgetList');
        const recentPurchasesList = document.getElementById('recentPurchasesList');


        // --- Variables de Configuración (ahora guardadas en Firestore o localStorage como fallback) ---
        let minStockThreshold = parseInt(localStorage.getItem('minStockThreshold') || '10');
        let defaultProfitMargin = parseFloat(localStorage.getItem('defaultProfitMargin') || '50');

        // Paginación
        let productsPerPage = 10;
        let currentProductPage = 1;
        let filteredProducts = [];

        let purchasesPerPage = 10;
        let currentPurchasePage = 1;
        let filteredPurchases = [];

        let salesPerPage = 10;
        let currentSalePage = 1;
        let filteredSales = [];


        // --- Funciones de Utilidad ---

        /**
         * Muestra un spinner de carga global.
         */
        function showLoading() {
            document.getElementById('loadingSpinner').classList.remove('hidden');
        }

        /**
         * Oculta el spinner de carga global.
         */
        function hideLoading() {
            document.getElementById('loadingSpinner').classList.add('hidden');
        }

        /**
         * Muestra una caja de mensajes personalizada en lugar de alert() o confirm().
         * @param {string} title - Título del mensaje.
         * @param {string} content - Contenido del mensaje.
         * @param {'success'|'error'|'info'} type - Tipo de mensaje para styling.
         * @param {function} [onConfirm] - Función a ejecutar si se "confirma" (solo para simular confirm).
         */
        function showMessageBox(title, content, type = 'info', onConfirm = null) {
            messageBoxTitle.textContent = title;
            messageBoxContent.innerHTML = content; // Usar innerHTML para permitir contenido HTML si es necesario
            messageBox.classList.remove('hidden');

            // Remover clases de tipo anteriores
            messageBoxTitle.classList.remove('text-success-green', 'text-error-red', 'text-info-blue');
            messageBoxClose.classList.remove('bg-success-green', 'bg-error-red', 'bg-info-blue', 'bg-primary-accent');

            // Aplicar clases de tipo nuevas
            if (type === 'success') {
                messageBoxTitle.classList.add('text-success-green');
                messageBoxClose.classList.add('bg-success-green');
            } else if (type === 'error') {
                messageBoxTitle.classList.add('text-error-red');
                messageBoxClose.classList.add('bg-error-red');
            } else if (type === 'info') {
                messageBoxTitle.classList.add('text-info-blue');
                messageBoxClose.classList.add('bg-info-blue');
            } else {
                // Default a primary-accent si el tipo no es reconocido
                messageBoxClose.classList.add('bg-primary-accent');
            }

            // Manejar la acción de confirmación si se proporciona
            messageBoxClose.onclick = () => {
                messageBox.classList.add('hidden');
                if (onConfirm) {
                    onConfirm();
                }
                messageBoxClose.onclick = null; // Limpiar el listener para evitar múltiples ejecuciones
            };
        }


        // --- Lógica de Navegación de Módulos (Delegación de Eventos) ---

        /**
         * Cambia el módulo activo de la interfaz.
         * @param {string} moduleName - El nombre del módulo a activar (ej. 'inventario').
         */
        function switchModule(moduleName) {
            const targetModuleId = moduleName + '-module';

            // Remover 'active' de todos los nav-items
            navItems.forEach(navItem => navItem.classList.remove('active'));

            // Remover 'active' de todos los módulos de contenido
            moduleContents.forEach(moduleContent => moduleContent.classList.remove('active'));

            // Añadir 'active' al módulo objetivo
            document.getElementById(targetModuleId).classList.add('active');
            moduleTitle.textContent = moduleName.charAt(0).toUpperCase() + moduleName.slice(1); // Capitalizar el nombre del módulo

            // Resaltar el nav-item activo
            const activeNavItem = document.querySelector(`.nav-item[data-section="${moduleName}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // Cargar datos y actualizar UI para el módulo activo
            if (moduleName === 'inventario') {
                applyProductFiltersAndRenderTable();
                populateCategoryFilter();
            } else if (moduleName === 'compras') {
                applyPurchaseFiltersAndRenderTable();
            } else if (moduleName === 'ventas') {
                applySaleFiltersAndRenderTable();
                loadClientsFromFirestore(); // Cargar clientes desde Firestore
                populateFrequentProductsSuggestions();
            } else if (moduleName === 'dashboard') {
                updateDashboardMetrics();
                renderSalesChart();
                renderCategorySalesChart();
                updateTopSellingProducts();
                updateLowStockProducts();
                updateLowStockWidget(); // Asegurar que el widget se actualice
                updateRecentSalesWidget(); // Asegurar que el widget se actualice
                updateRecentPurchasesWidget(); // Asegurar que el widget se actualice
            }
        }


        // Delegación de eventos para la navegación principal (PC y Móvil)
        navContainer.addEventListener('click', (e) => {
            const item = e.target.closest('.nav-item');
            if (!item) return;
            e.preventDefault();

            if (item.classList.contains('toggle-btn')) {
                // Manejado por la clase NavigationBar
            } else {
                switchModule(item.dataset.section);
            }
        });


        // --- Lógica de Barra Lateral Principal (Colapsar/Expandir en PC) ---

        /**
         * Clase para gestionar la funcionalidad de la barra de navegación.
         * Incluye manejo de estado activo y responsividad.
         */
        class NavigationBar {
            constructor() {
                this.items = document.querySelectorAll('.nav-item');
                this.navbar = document.querySelector('.navbar');
                this.toggleButton = document.querySelector('.toggle-btn');
                this.mainContentArea = document.getElementById('mainContentArea');
                this.isExpanded = document.body.classList.contains('sidebar-expanded');

                this.init();
            }

            init() {
                this.items.forEach((item) => {
                    item.addEventListener('click', (e) => this.handleClick(e, item));
                });

                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => this.handleResize(), 200);
                });
                window.addEventListener('orientationchange', () => this.handleResize());

                this.updateLayout();
            }

            handleClick(e, item) {
                e.preventDefault();

                if (item.classList.contains('toggle-btn')) {
                    this.toggleNavbar();
                    return;
                }

                // La función `switchModule` ya maneja el establecimiento de la clase `active`.
                // No es necesario eliminar/añadir 'active' manualmente aquí.
                // `switchModule` se llama desde el listener de eventos global en `navContainer`.

                if (navigator.vibrate) {
                    navigator.vibrate(15);
                }
            }

            toggleNavbar() {
                if (window.innerWidth > 768) {
                    this.isExpanded = !this.isExpanded;
                    document.body.classList.toggle('sidebar-expanded', this.isExpanded);
                    document.body.classList.toggle('sidebar-collapsed', !this.isExpanded);
                    this.updateLayout();
                }
            }

            handleResize() {
                if (window.innerWidth < 768) { // Móvil
                    document.body.classList.remove('sidebar-expanded', 'sidebar-collapsed');
                    this.mainContentArea.style.marginLeft = '0';
                    this.mainContentArea.style.marginBottom = '5rem'; // Espacio para la barra inferior móvil
                    // Asegurar que navContainer y navbar se adapten correctamente en móvil
                    navContainer.style.width = '100%';
                    navContainer.style.height = 'auto';
                    navContainer.style.top = 'auto';
                    navContainer.style.bottom = '0';
                    navContainer.style.left = '0';
                    navContainer.style.right = '0';

                    navbar.style.width = 'auto';
                    navbar.style.height = 'auto';
                    navbar.style.borderRadius = '0';
                    navbar.style.padding = '0';
                    navbar.style.background = 'transparent';
                    navbar.style.backdropFilter = 'none';
                    navbar.style.border = 'none';
                    navbar.style.boxShadow = 'none';
                } else { // Escritorio
                    this.mainContentArea.style.marginBottom = '0'; // Eliminar margen inferior
                    // Volver a aplicar el estado de escritorio basado en `isExpanded`
                    document.body.classList.toggle('sidebar-expanded', this.isExpanded);
                    document.body.classList.toggle('sidebar-collapsed', !this.isExpanded);
                    this.updateLayout();
                    navContainer.style.width = this.isExpanded ? '20rem' : '5rem';
                    navContainer.style.height = '100vh';
                    navContainer.style.top = '0';
                    navContainer.style.bottom = 'auto';
                    navContainer.style.left = '0';
                    navContainer.style.right = 'auto';

                    // Restablecer estilos de navbar para escritorio
                    navbar.style.background = 'var(--glass)';
                    navbar.style.backdropFilter = 'blur(30px) saturate(200%)';
                    navbar.style.border = '1px solid var(--glass-border)';
                    navbar.style.boxShadow = 'var(--shadow-lg)';
                    navbar.style.borderRadius = '40px';
                    navbar.style.padding = '1.5rem 0.5rem';
                    navbar.style.flexDirection = 'column';
                }
            }

            updateLayout() {
                if (window.innerWidth > 768) {
                    this.mainContentArea.style.marginLeft = this.isExpanded ? '20rem' : '5rem';
                } else {
                    this.mainContentArea.style.marginLeft = '';
                }
            }
        }

        // Inicializar la nueva clase NavigationBar
        document.addEventListener('DOMContentLoaded', () => {
            new NavigationBar();
        });


        // --- Lógica de Barra Lateral Secundaria (Herramientas) ---

        toggleSecondarySidebarBtn.addEventListener('click', () => {
            secondarySidebar.classList.remove('translate-x-full');
        });

        closeSecondarySidebarBtn.addEventListener('click', () => {
            secondarySidebar.classList.add('translate-x-full');
        });

        // --- Lógica de Modales ---

        openNewProductModalBtn.addEventListener('click', () => {
            newProductForm.reset(); // Limpiar formulario al abrir
            imagePreview.innerHTML = `<i class="fas fa-image text-4xl" aria-hidden="true"></i>`; // Restablecer vista previa de imagen
            productCodeInput.value = generateProductCode(); // Generar nuevo código
            suggestedPriceInput.value = `$0.00`; // Resetear precio sugerido
            profitMarginInput.value = defaultProfitMargin; // Cargar margen de ganancia por defecto
            newProductModal.classList.remove('hidden');
        });

        openNewPurchaseModalBtn.addEventListener('click', () => {
            document.getElementById('newPurchaseForm').reset();
            document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
            document.querySelector('#purchaseProductsTable tbody').innerHTML = ''; // Limpiar productos de la compra
            document.getElementById('purchaseTotal').textContent = '$0.00';
            newPurchaseModal.classList.remove('hidden');
        });

        openNewSaleModalBtn.addEventListener('click', () => {
            document.getElementById('newSaleForm').reset();
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            saleProductsTableBody.innerHTML = '';
            updateSaleTotal();
            loadClientsFromFirestore();
            populateFrequentProductsSuggestions();
            newSaleModal.classList.remove('hidden');
        });

        openNewReturnModalBtn.addEventListener('click', () => {
            document.getElementById('newReturnForm').reset();
            newReturnModal.classList.remove('hidden');
        });

        closeModalBtns.forEach(button => {
            button.addEventListener('click', () => {
                newProductModal.classList.add('hidden');
                newPurchaseModal.classList.add('hidden');
                newSaleModal.classList.add('hidden');
                newReturnModal.classList.add('hidden');
            });
        });

        // --- Funciones de Firebase Firestore ---

        /**
         * Obtiene la ruta de la colección de Firestore para un nombre de colección dado.
         * Utiliza el appId y userId globales.
         * @param {string} collectionName - El nombre de la colección (ej. 'products').
         * @returns {string} La ruta completa de la colección de Firestore.
         */
        function getCollectionPath(collectionName) {
            if (!window.userId) {
                console.error("El ID de usuario no está disponible para operaciones de Firestore.");
                // Fallback para almacenamiento local si userId no está configurado (ej. la inicialización de Firebase falló)
                return `local-${collectionName}`;
            }
            // Usando /artifacts/{appId}/users/{userId}/{your_collection_name} para datos privados
            return `artifacts/${window.appId}/users/${window.userId}/${collectionName}`;
        }

        /**
         * Configura los listeners en tiempo real para todas las colecciones de datos principales.
         * Esta función se llama una vez que la autenticación de Firebase está lista.
         */
        function setupFirestoreListeners() {
            if (!window.db || !window.userId) {
                console.warn("Firestore o el ID de usuario no están listos, se omite la configuración de listeners.");
                return;
            }

            // Listener de Productos
            onSnapshot(collection(window.db, getCollectionPath('products')), (snapshot) => {
                productsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Productos actualizados:", productsData);
                applyProductFiltersAndRenderTable();
                populateCategoryFilter();
                updateDashboardMetrics();
                updateLowStockProducts();
                updateLowStockWidget();
            }, (error) => {
                console.error("Error al escuchar productos:", error);
                showMessageBox('Error de Sincronización', 'No se pudieron cargar los productos en tiempo real. Intente recargar la página.', 'error');
            });

            // Listener de Compras
            onSnapshot(collection(window.db, getCollectionPath('purchases')), (snapshot) => {
                purchasesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Compras actualizadas:", purchasesData);
                applyPurchaseFiltersAndRenderTable();
                updateDashboardMetrics();
                updateRecentPurchasesWidget();
            }, (error) => {
                console.error("Error al escuchar compras:", error);
                showMessageBox('Error de Sincronización', 'No se pudieron cargar las compras en tiempo real. Intente recargar la página.', 'error');
            });

            // Listener de Ventas
            onSnapshot(collection(window.db, getCollectionPath('sales')), (snapshot) => {
                salesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Ventas actualizadas:", salesData);
                applySaleFiltersAndRenderTable();
                updateDashboardMetrics();
                updateRecentSalesWidget();
                populateFrequentProductsSuggestions(); // Los datos de ventas afectan los productos frecuentes
            }, (error) => {
                console.error("Error al escuchar ventas:", error);
                showMessageBox('Error de Sincronización', 'No se pudieron cargar las ventas en tiempo real. Intente recargar la página.', 'error');
            });

            // Listener de Clientes (para datalist)
            onSnapshot(collection(window.db, getCollectionPath('clients')), (snapshot) => {
                clientsData = snapshot.docs.map(doc => doc.data().name); // Asumiendo que los documentos de cliente solo almacenan { name: "Nombre del Cliente" }
                console.log("Clientes actualizados:", clientsData);
                loadClientsFromFirestore();
            }, (error) => {
                console.error("Error al escuchar clientes:", error);
            });

            // Listener de Recordatorios
            onSnapshot(collection(window.db, getCollectionPath('reminders')), (snapshot) => {
                const reminders = snapshot.docs.map(doc => ({ id: doc.id, text: doc.data().text }));
                console.log("Recordatorios actualizados:", reminders);
                loadReminders(reminders);
            }, (error) => {
                console.error("Error al escuchar recordatorios:", error);
            });

            // Listener de Bloc de Notas (documento único)
            onSnapshot(doc(window.db, getCollectionPath('settings'), 'notepad'), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    notepad.value = docSnapshot.data().note || '';
                    console.log("Bloc de notas cargado desde Firestore.");
                } else {
                    notepad.value = '';
                    console.log("No se encontró ninguna nota de bloc de notas en Firestore.");
                }
            }, (error) => {
                console.error("Error al escuchar bloc de notas:", error);
            });

            // Listener de Configuración (para minStockThreshold y defaultProfitMargin)
            onSnapshot(doc(window.db, getCollectionPath('settings'), 'appConfig'), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const config = docSnapshot.data();
                    minStockThreshold = config.minStockThreshold || 10;
                    defaultProfitMargin = config.defaultProfitMargin || 50;
                    minStockThresholdInput.value = minStockThreshold;
                    defaultMarginInput.value = defaultProfitMargin;
                    console.log("Configuración de la aplicación cargada desde Firestore:", config);
                    applyStockAlerts(); // Volver a aplicar alertas con el nuevo umbral
                } else {
                    console.log("No se encontró ninguna configuración de la aplicación en Firestore, usando valores por defecto.");
                    // Guardar valores por defecto en Firestore si no existen
                    setDoc(doc(window.db, getCollectionPath('settings'), 'appConfig'), {
                        minStockThreshold: minStockThreshold,
                        defaultProfitMargin: defaultProfitMargin
                    }, { merge: true });
                }
            }, (error) => {
                console.error("Error al escuchar la configuración de la aplicación:", error);
            });
        }


        // --- Simulación de Envío de Formularios (Lógica de Negocio con Firestore) ---

        newProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            // Validación básica del formulario
            if (!productNameInput.value || !unitCostInput.value || !initialStockInput.value || !categoryInput.value) {
                hideLoading();
                showMessageBox('Error de Validación', 'Por favor, complete todos los campos obligatorios marcados con (*).', 'error');
                return;
            }

            const newProduct = {
                name: productNameInput.value,
                description: productDescriptionInput.value,
                unitCost: parseFloat(unitCostInput.value),
                profitMargin: parseFloat(profitMarginInput.value),
                suggestedPrice: parseFloat(suggestedPriceInput.value.replace('$', '')),
                stock: parseInt(initialStockInput.value),
                category: categoryInput.value,
                supplier: supplierInput.value,
                imageUrl: imagePreview.querySelector('img') ? imagePreview.querySelector('img').src : ''
            };

            try {
                // Añadir un nuevo documento con un ID generado
                const docRef = await addDoc(collection(window.db, getCollectionPath('products')), newProduct);
                console.log("Producto guardado con ID: ", docRef.id);
                showMessageBox('Producto Guardado', 'El producto ha sido guardado exitosamente.', 'success');
                newProductModal.classList.add('hidden');
            } catch (e) {
                console.error("Error al añadir documento: ", e);
                showMessageBox('Error', `No se pudo guardar el producto: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        document.getElementById('newPurchaseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const purchaseDate = document.getElementById('purchaseDate').value;
            const purchaseSupplier = document.getElementById('purchaseSupplier').value;
            const purchaseItems = [];
            let currentPurchaseTotal = 0;

            document.querySelectorAll('#purchaseProductsTable tbody tr').forEach(row => {
                const productId = row.dataset.productId;
                const name = row.children[0].textContent;
                const quantity = parseInt(row.querySelector('.quantity-input').value);
                const unitCost = parseFloat(row.querySelector('.cost-input').value);
                purchaseItems.push({
                    productId,
                    name,
                    quantity,
                    unitCost
                });
                currentPurchaseTotal += quantity * unitCost;
            });

            if (!purchaseDate || !purchaseSupplier || purchaseItems.length === 0) {
                hideLoading();
                showMessageBox('Error de Validación', 'Por favor, complete la fecha, el proveedor y añada al menos un producto a la compra.', 'error');
                return;
            }

            const newPurchase = {
                date: purchaseDate,
                supplier: purchaseSupplier,
                items: purchaseItems,
                total: currentPurchaseTotal
            };

            try {
                const docRef = await addDoc(collection(window.db, getCollectionPath('purchases')), newPurchase);
                console.log("Compra guardada con ID: ", docRef.id);

                // Actualizar stock de productos
                for (const item of newPurchase.items) {
                    const productRef = doc(window.db, getCollectionPath('products'), item.productId);
                    const productSnap = await getDoc(productRef);
                    if (productSnap.exists()) {
                        const currentStock = productSnap.data().stock || 0;
                        await updateDoc(productRef, { stock: currentStock + item.quantity });
                    } else {
                        console.warn(`Producto con ID ${item.productId} no encontrado para actualizar stock.`);
                    }
                }
                showMessageBox('Compra Registrada', 'La compra ha sido registrada exitosamente y el stock actualizado.', 'success');
                newPurchaseModal.classList.add('hidden');
            } catch (e) {
                console.error("Error al añadir compra o actualizar stock: ", e);
                showMessageBox('Error', `No se pudo registrar la compra: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        document.getElementById('newSaleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const saleDate = document.getElementById('saleDate').value;
            const saleClient = saleClientInput.value.trim();
            const paymentMethod = paymentMethodSelect.value;
            const saleItems = [];
            let currentSaleTotal = 0;

            for (const row of document.querySelectorAll('#saleProductsTable tbody tr')) {
                const productId = row.dataset.productId;
                const name = row.children[0].textContent;
                const quantity = parseInt(row.querySelector('.quantity-input').value);
                const finalPrice = parseFloat(row.querySelector('.final-price-input').value);
                saleItems.push({
                    productId,
                    name,
                    quantity,
                    finalPrice
                });
                currentSaleTotal += quantity * finalPrice;
            }

            if (!saleDate || !paymentMethod || saleItems.length === 0) {
                hideLoading();
                showMessageBox('Error de Validación', 'Por favor, complete la fecha, el método de pago y añada al menos un producto a la venta.', 'error');
                return;
            }

            const newSale = {
                date: saleDate,
                client: saleClient || 'Cliente Anónimo',
                paymentMethod: paymentMethod,
                items: saleItems,
                total: currentSaleTotal
            };

            try {
                const docRef = await addDoc(collection(window.db, getCollectionPath('sales')), newSale);
                console.log("Venta guardada con ID: ", docRef.id);

                // Actualizar stock de productos
                for (const item of newSale.items) {
                    const productRef = doc(window.db, getCollectionPath('products'), item.productId);
                    const productSnap = await getDoc(productRef);
                    if (productSnap.exists()) {
                        const currentStock = productSnap.data().stock || 0;
                        await updateDoc(productRef, { stock: currentStock - item.quantity });
                    } else {
                        console.warn(`Producto con ID ${item.productId} no encontrado para actualizar stock.`);
                    }
                }

                if (saleClient) {
                    // Guardar cliente en Firestore si es un cliente nuevo
                    const clientsCollection = collection(window.db, getCollectionPath('clients'));
                    const clientQuery = query(clientsCollection, where("name", "==", saleClient));
                    const clientSnap = await getDocs(clientQuery);
                    if (clientSnap.empty) {
                        await addDoc(clientsCollection, { name: saleClient });
                    }
                }

                showMessageBox('Venta Registrada', 'La venta ha sido registrada exitosamente y el stock actualizado.', 'success');
                newSaleModal.classList.add('hidden');
            } catch (e) {
                console.error("Error al añadir venta o actualizar stock: ", e);
                showMessageBox('Error', `No se pudo registrar la venta: ${e.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        document.getElementById('newReturnForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const returnProductName = document.getElementById('returnProductName').value;
            const returnQuantity = parseInt(document.getElementById('returnQuantity').value);
            const returnRefundAmount = parseFloat(document.getElementById('returnRefundAmount').value);
            const returnReason = document.getElementById('returnReason').value;

            if (!returnProductName || !returnQuantity || !returnRefundAmount || !returnReason) {
                hideLoading();
                showMessageBox('Error de Validación', 'Por favor, complete todos los campos obligatorios para la devolución.', 'error');
                return;
            }

            try {
                // Encontrar el producto por nombre (considerar usar el ID del producto para mayor robustez)
                const productQuery = query(collection(window.db, getCollectionPath('products')), where("name", "==", returnProductName));
                const productSnap = await getDocs(productQuery);

                if (!productSnap.empty) {
                    const productDoc = productSnap.docs[0];
                    const productRef = doc(window.db, getCollectionPath('products'), productDoc.id);
                    const currentStock = productDoc.data().stock || 0;

                    await updateDoc(productRef, { stock: currentStock + returnQuantity });

                    // Opcionalmente, registrar la devolución en una colección 'returns'
                    await addDoc(collection(window.db, getCollectionPath('returns')), {
                        productId: productDoc.id,
                        productName: returnProductName,
                        quantity: returnQuantity,
                        refundAmount: returnRefundAmount,
                        reason: returnReason,
                        date: new Date().toISOString().split('T')[0]
                    });

                    showMessageBox('Devolución Registrada', `Devolución de ${returnQuantity} unidades de ${returnProductName} registrada. Stock actualizado.`, 'success');
                } else {
                    showMessageBox('Producto No Encontrado', `El producto "${returnProductName}" no se encontró en el inventario.`, 'error');
                }
            } catch (e) {
                console.error("Error al procesar la devolución: ", e);
                showMessageBox('Error', `No se pudo registrar la devolución: ${e.message}`, 'error');
            } finally {
                hideLoading();
                newReturnModal.classList.add('hidden');
            }
        });


        // --- Generación de Código de Producto (Firestore usa sus propios IDs) ---
        // Esta función es ahora principalmente para visualización/marcador de posición, ya que Firestore asigna IDs únicos.
        function generateProductCode() {
            const now = new Date();
            const year = String(now.getFullYear()).slice(-2);
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const randomChars = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `SKU-${year}${month}${day}-${hours}${minutes}${seconds}-${randomChars}`;
        }

        // --- Cálculo del Precio de Venta Sugerido ---
        function calculateSuggestedPrice() {
            const cost = parseFloat(unitCostInput.value);
            const margin = parseFloat(profitMarginInput.value);
            if (isFinite(cost) && isFinite(margin) && cost >= 0 && margin >= 0) {
                const suggestedPrice = cost * (1 + margin / 100);
                suggestedPriceInput.value = `$${suggestedPrice.toFixed(2)}`;
            } else {
                suggestedPriceInput.value = '$0.00';
            }
        }
        unitCostInput.addEventListener('input', calculateSuggestedPrice);
        profitMarginInput.addEventListener('input', calculateSuggestedPrice);

        // --- Vista previa de la imagen del producto ---
        productImageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.innerHTML = `<img src="${e.target.result}" alt="Imagen del producto" class="w-full h-full object-cover rounded-xl">`;
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.innerHTML = `<i class="fas fa-image text-4xl" aria-hidden="true"></i>`;
            }
        });

        // --- Funcionalidad del Anotador (con Firestore) ---
        saveNoteBtn.addEventListener('click', async () => {
            if (!window.db || !window.userId) {
                localStorage.setItem('VERTEX_notepad_note', notepad.value);
                showMessageBox('Nota Guardada Localmente', 'Tu nota ha sido guardada en el almacenamiento local (sin conexión a la nube).', 'info');
                return;
            }
            try {
                await setDoc(doc(window.db, getCollectionPath('settings'), 'notepad'), { note: notepad.value });
                showMessageBox('Nota Guardada', 'Tu nota ha sido guardada en la nube.', 'success');
            } catch (e) {
                console.error("Error al guardar nota:", e);
                showMessageBox('Error', 'No se pudo guardar la nota en la nube.', 'error');
            }
        });

        loadNoteBtn.addEventListener('click', async () => {
            if (!window.db || !window.userId) {
                const savedNote = localStorage.getItem('VERTEX_notepad_note');
                if (savedNote) {
                    notepad.value = savedNote;
                    showMessageBox('Nota Cargada Localmente', 'Tu nota ha sido cargada desde el almacenamiento local.', 'info');
                } else {
                    showMessageBox('Sin Notas', 'No hay notas guardadas localmente.', 'info');
                }
                return;
            }
            // Los datos se cargan automáticamente a través de onSnapshot en setupFirestoreListeners
            showMessageBox('Nota Sincronizada', 'La nota se carga automáticamente desde la nube.', 'info');
        });


        // --- Funcionalidad de Recordatorios de Tareas Pendientes (con Firestore) ---
        function loadReminders(reminders) {
            reminderList.innerHTML = '';
            if (reminders.length === 0) {
                const li = document.createElement('li');
                li.classList.add('text-text-secondary', 'text-sm', 'text-center', 'py-2');
                li.textContent = 'No hay recordatorios.';
                reminderList.appendChild(li);
                return;
            }
            reminders.forEach((reminder) => {
                const li = document.createElement('li');
                li.classList.add('flex', 'items-center', 'justify-between', 'bg-gray-700', 'p-2', 'rounded-lg', 'text-white', 'text-sm');
                li.innerHTML = `
                    <span>${reminder.text}</span>
                    <button class="text-error-red hover:text-red-600 ml-2 delete-reminder" data-id="${reminder.id}" aria-label="Eliminar recordatorio">
                        <i class="fas fa-times" aria-hidden="true"></i>
                    </button>
                `;
                reminderList.appendChild(li);
            });
            document.querySelectorAll('.delete-reminder').forEach(button => {
                button.addEventListener('click', (e) => {
                    const reminderId = e.target.closest('button').dataset.id;
                    deleteReminder(reminderId);
                });
            });
        }

        async function addReminder() {
            const reminderText = newReminderInput.value.trim();
            if (!reminderText) {
                showMessageBox('Error', 'Por favor, escribe un recordatorio.', 'error');
                return;
            }
            if (!window.db || !window.userId) {
                showMessageBox('Error de Conexión', 'No se pudo añadir el recordatorio. Firebase no está conectado.', 'error');
                return;
            }
            try {
                await addDoc(collection(window.db, getCollectionPath('reminders')), { text: reminderText, createdAt: new Date() });
                newReminderInput.value = '';
                showMessageBox('Recordatorio Añadido', 'Recordatorio guardado exitosamente en la nube.', 'success');
            } catch (e) {
                console.error("Error al añadir recordatorio:", e);
                showMessageBox('Error', 'No se pudo añadir el recordatorio en la nube.', 'error');
            }
        }

        async function deleteReminder(id) {
            if (!window.db || !window.userId) {
                showMessageBox('Error de Conexión', 'No se pudo eliminar el recordatorio. Firebase no está conectado.', 'error');
                return;
            }
            try {
                await deleteDoc(doc(window.db, getCollectionPath('reminders'), id));
                showMessageBox('Recordatorio Eliminado', 'Recordatorio eliminado exitosamente de la nube.', 'info');
            } catch (e) {
                console.error("Error al eliminar recordatorio:", e);
                showMessageBox('Error', 'No se pudo eliminar el recordatorio de la nube.', 'error');
            }
        }

        addReminderBtn.addEventListener('click', addReminder);
        newReminderInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addReminder();
            }
        });


        // --- Funcionalidad de la Calculadora Rápida ---

        let currentInput = '0';
        let operator = null;
        let firstOperand = null;
        let waitingForSecondOperand = false;

        function updateDisplay() {
            calculatorDisplay.value = currentInput;
        }

        calculatorButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const value = e.target.dataset.value;

                if (value === 'C') {
                    currentInput = '0';
                    operator = null;
                    firstOperand = null;
                    waitingForSecondOperand = false;
                } else if (value === '=') {
                    if (operator && firstOperand !== null) {
                        const secondOperand = parseFloat(currentInput);
                        let result;
                        try {
                            switch (operator) {
                                case '+':
                                    result = firstOperand + secondOperand;
                                    break;
                                case '-':
                                    result = firstOperand - secondOperand;
                                    break;
                                case '*':
                                    result = firstOperand * secondOperand;
                                    break;
                                case '/':
                                    if (secondOperand === 0) {
                                        showMessageBox('Error de Cálculo', 'No se puede dividir por cero.', 'error');
                                        currentInput = 'Error';
                                        return;
                                    }
                                    result = firstOperand / secondOperand;
                                    break;
                            }
                            currentInput = String(result);
                        } catch (error) {
                            showMessageBox('Error de Cálculo', 'Ha ocurrido un error en la operación.', 'error');
                            currentInput = 'Error';
                        }
                        firstOperand = null;
                        operator = null;
                        waitingForSecondOperand = false;
                    }
                } else if (['+', '-', '*', '/'].includes(value)) {
                    if (firstOperand === null) {
                        firstOperand = parseFloat(currentInput);
                    } else if (operator) {
                        const secondOperand = parseFloat(currentInput);
                        let result;
                        try {
                            switch (operator) {
                                case '+':
                                    result = firstOperand + secondOperand;
                                    break;
                                case '-':
                                    result = firstOperand - secondOperand;
                                    break;
                                case '*':
                                    result = firstOperand * secondOperand;
                                    break;
                                case '/':
                                    if (secondOperand === 0) {
                                        showMessageBox('Error de Cálculo', 'No se puede dividir por cero.', 'error');
                                        currentInput = 'Error';
                                        return;
                                    }
                                    result = firstOperand / secondOperand;
                                    break;
                            }
                            firstOperand = result;
                            currentInput = String(result);
                        } catch (error) {
                            showMessageBox('Error de Cálculo', 'Ha ocurrido un error en la operación.', 'error');
                            currentInput = 'Error';
                        }
                    }
                    operator = value;
                    waitingForSecondOperand = true;
                } else if (value === '.') {
                    if (!currentInput.includes('.')) {
                        currentInput += '.';
                    }
                } else { // Números
                    if (waitingForSecondOperand || currentInput === '0' || currentInput === 'Error') {
                        currentInput = value;
                        waitingForSecondOperand = false;
                    } else {
                        currentInput += value;
                    }
                }
                updateDisplay();
            });
        });
        updateDisplay();

        // --- Funcionalidad básica del Calendario ---

        const currentMonthYearSpan = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const calendarDaysContainer = document.getElementById('calendarDays');
        let currentDateCalendar = new Date(); // Usar una variable diferente para el calendario

        function updateCalendarDisplay() {
            const options = {
                month: 'long',
                year: 'numeric'
            };
            currentMonthYearSpan.textContent = currentDateCalendar.toLocaleDateString('es-ES', options);

            // Limpiar días anteriores
            // Mantener los primeros 7 divs para los nombres de los días (Lun, Mar, etc.)
            const existingDayElements = calendarDaysContainer.querySelectorAll('.py-1:not(.text-gray-400)');
            existingDayElements.forEach(day => day.remove());


            // Obtener el primer día del mes actual
            const firstDayOfMonth = new Date(currentDateCalendar.getFullYear(), currentDateCalendar.getMonth(), 1);
            // Obtener el último día del mes actual
            const lastDayOfMonth = new Date(currentDateCalendar.getFullYear(), currentDateCalendar.getMonth() + 1, 0);

            // Calcular el día de la semana del primer día (0=domingo, 1=lunes, etc.)
            let startDay = firstDayOfMonth.getDay();
            if (startDay === 0) startDay = 7; // Ajustar para que lunes sea 1, domingo sea 7

            // Rellenar con días vacíos al principio para alinear con el lunes
            for (let i = 1; i < startDay; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.classList.add('py-1');
                calendarDaysContainer.appendChild(emptyDiv);
            }

            // Rellenar con los días del mes
            for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('py-1');
                dayDiv.textContent = i;
                if (i === new Date().getDate() && currentDateCalendar.getMonth() === new Date().getMonth() && currentDateCalendar.getFullYear() === new Date().getFullYear()) {
                    dayDiv.classList.add('bg-primary-accent', 'rounded-full', 'text-white');
                }
                calendarDaysContainer.appendChild(dayDiv);
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            currentDateCalendar.setMonth(currentDateCalendar.getMonth() - 1);
            updateCalendarDisplay();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDateCalendar.setMonth(currentDateCalendar.getMonth() + 1);
            updateCalendarDisplay();
        });

        updateCalendarDisplay();

        // --- Funcionalidad de Exportación CSV ---

        function exportTableToCSV(tableBodyId, filename) {
            const tableBody = document.getElementById(tableBodyId);
            let csv = [];
            let headers = [];
            // Obtener encabezados de la tabla (excluyendo 'Acciones')
            const headerRow = tableBody.previousElementSibling.querySelector('tr');
            headerRow.querySelectorAll('th').forEach((th, index) => {
                if (th.textContent.trim() !== 'Acciones') {
                    headers.push(th.textContent.trim());
                }
            });
            csv.push(headers.join(','));

            // Obtener datos de las filas
            tableBody.querySelectorAll('tr').forEach(row => {
                let rowData = [];
                row.querySelectorAll('td').forEach((td, index) => {
                    // Excluir la última columna (Acciones)
                    if (index !== row.children.length - 1) {
                        let cellText = td.querySelector('input') ? td.querySelector('input').value : td.textContent.trim();
                        // Escapar comillas dobles y encerrar en comillas si el texto contiene comas
                        cellText = `"${cellText.replace(/"/g, '""')}"`;
                        rowData.push(cellText);
                    }
                });
                csv.push(rowData.join(','));
            });

            const csvFile = new Blob([csv.join('\n')], {
                type: 'text/csv;charset=utf-8;'
            });
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(csvFile);
            downloadLink.download = filename;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            showMessageBox('Exportación Completa', `Los datos han sido exportados a ${filename}.`, 'success');
        }

        exportInventoryCSVBtn.addEventListener('click', () => {
            exportTableToCSV('inventoryTableBody', 'inventario.csv');
        });

        exportSalesCSVBtn.addEventListener('click', () => {
            exportTableToCSV('salesTableBody', 'ventas.csv');
        });

        // --- Funcionalidad de Impresión ---
        printInventoryBtn.addEventListener('click', () => {
            window.print();
        });

        // --- Listener para cerrar la caja de mensajes ---
        messageBoxClose.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // --- Lógica de Adición de Productos a la Venta (Dinámico) ---
        addProductToSaleBtn.addEventListener('click', () => {
            const searchTerm = productSearchSaleInput.value.trim().toLowerCase();
            const productToAdd = productsData.find(p =>
                p.name.toLowerCase().includes(searchTerm) || p.id.toLowerCase().includes(searchTerm)
            );

            if (productToAdd) {
                addProductRowToSale(productToAdd.name, productToAdd.id, productToAdd.suggestedPrice, 1);
                productSearchSaleInput.value = '';
            } else {
                showMessageBox('Producto no encontrado', 'No se encontró un producto que coincida con la búsqueda.', 'error');
            }
        });

        // --- Lógica para añadir filas de producto a la venta ---
        function addProductRowToSale(productName, productCode, suggestedPrice, quantity) {
            // Verificar si el producto ya está en la tabla de venta
            const existingRow = Array.from(saleProductsTableBody.children).find(row =>
                row.dataset.productId === productCode
            );

            if (existingRow) {
                const quantityInput = existingRow.querySelector('.quantity-input');
                quantityInput.value = parseInt(quantityInput.value) + quantity;
            } else {
                const newRow = document.createElement('tr');
                newRow.classList.add('border-b', 'border-border-gray', 'hover:bg-bg-lightest');
                newRow.dataset.productId = productCode; // Guardar el ID del producto
                newRow.innerHTML = `
                    <td class="py-2 px-3">${productName}</td>
                    <td class="py-2 px-3">${productCode}</td>
                    <td class="py-2 px-3">
                        <input type="number" value="${quantity}" min="1" class="w-20 p-1 border border-border-gray rounded-lg quantity-input" aria-label="Cantidad de ${productName}">
                    </td>
                    <td class="py-2 px-3 sale-suggested-price">$${suggestedPrice.toFixed(2)}</td>
                    <td class="py-2 px-3">
                        <input type="number" value="${suggestedPrice.toFixed(2)}" class="w-24 p-1 border border-border-gray rounded-lg final-price-input" step="0.01" aria-label="Precio final de ${productName}">
                    </td>
                    <td class="py-2 px-3">
                        <button class="bg-error-red text-white px-2 py-1 rounded-lg text-xs hover:bg-red-600 remove-sale-item" aria-label="Eliminar ${productName} de la venta">Eliminar</button>
                    </td>
                `;
                saleProductsTableBody.appendChild(newRow);
            }

            // Añadir listeners a los nuevos inputs y botones de eliminar
            const quantityInput = newRow.querySelector('.quantity-input');
            const finalPriceInput = newRow.querySelector('.final-price-input');
            const removeButton = newRow.querySelector('.remove-sale-item');

            quantityInput.addEventListener('input', updateSaleTotal);
            finalPriceInput.addEventListener('input', updateSaleTotal);
            removeButton.addEventListener('click', (e) => {
                e.target.closest('tr').remove();
                updateSaleTotal();
            });

            updateSaleTotal(); // Actualizar el total de la venta
        }

        /**
         * Calcula y actualiza el total de la venta.
         */
        function updateSaleTotal() {
            let total = 0;
            saleProductsTableBody.querySelectorAll('tr').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const finalPrice = parseFloat(row.querySelector('.final-price-input').value) || 0;
                total += (quantity * finalPrice);
            });
            saleTotalSpan.textContent = `$${total.toFixed(2)}`;
        }

        // --- Lógica para el método de pago "Debe" ---
        function updateDebeIndicator() {
            if (paymentMethodSelect.value === 'Debe') {
                debeIndicator.classList.remove('hidden');
            } else {
                debeIndicator.classList.add('hidden');
            }
        }
        paymentMethodSelect.addEventListener('change', updateDebeIndicator);


        // --- Lógica para recordar clientes (con Firestore) ---
        function loadClientsFromFirestore() {
            clientDatalist.innerHTML = ''; // Limpiar opciones anteriores
            clientsData.forEach(clientName => {
                const option = document.createElement('option');
                option.value = clientName;
                clientDatalist.appendChild(option);
            });
        }


        // --- Lógica de Sugerencias Inteligentes (Productos Frecuentes) ---
        function populateFrequentProductsSuggestions() {
            frequentProductsSuggestions.innerHTML = '';
            // Simulación: Obtener los 3 productos más vendidos
            const salesCounts = {};
            salesData.forEach(sale => {
                sale.items.forEach(item => {
                    salesCounts[item.productId] = (salesCounts[item.productId] || 0) + item.quantity;
                });
            });

            const sortedProducts = Object.entries(salesCounts)
                .sort(([, countA], [, countB]) => countB - countA)
                .slice(0, 3)
                .map(([productId]) => productsData.find(p => p.id === productId))
                .filter(Boolean); // Eliminar posibles nulos si el producto no se encuentra

            if (sortedProducts.length === 0) {
                // Si no hay ventas, mostrar algunos productos de ejemplo de los primeros 3 productos en el inventario
                productsData.slice(0, 3).forEach(product => {
                    const span = document.createElement('span');
                    span.classList.add('cursor-pointer', 'bg-primary-accent', 'text-white', 'px-3', 'py-1', 'rounded-full', 'text-xs', 'hover:bg-primary-hover', 'transition-colors', 'duration-200');
                    span.dataset.product = product.name;
                    span.dataset.price = product.suggestedPrice;
                    span.textContent = product.name;
                    frequentProductsSuggestions.appendChild(span);
                });
            } else {
                sortedProducts.forEach(product => {
                    const span = document.createElement('span');
                    span.classList.add('cursor-pointer', 'bg-primary-accent', 'text-white', 'px-3', 'py-1', 'rounded-full', 'text-xs', 'hover:bg-primary-hover', 'transition-colors', 'duration-200');
                    span.dataset.product = product.name;
                    span.dataset.price = product.suggestedPrice;
                    span.textContent = product.name;
                    frequentProductsSuggestions.appendChild(span);
                });
            }
        }

        frequentProductsSuggestions.addEventListener('click', (e) => {
            const span = e.target.closest('span');
            if (span && span.dataset.product) {
                const productName = span.dataset.product;
                const productPrice = parseFloat(span.dataset.price);
                const productCode = productsData.find(p => p.name === productName)?.id || `SKU-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
                addProductRowToSale(productName, productCode, productPrice, 1);
            }
        });


        // --- Lógica de Control de Stock Mínimo/Máximo con Alertas Visuales ---
        // Función para aplicar estilos de alerta de stock
        function applyStockAlerts() {
            const inventoryRows = inventoryTableBody.querySelectorAll('tr');
            inventoryRows.forEach(row => {
                const stockCell = row.children[4]; // La quinta columna es el stock
                const stockValue = parseInt(stockCell.textContent);
                if (stockValue <= minStockThreshold) {
                    stockCell.classList.add('text-error-red', 'font-bold');
                } else {
                    stockCell.classList.remove('text-error-red', 'font-bold');
                }
            });
        }

        // Guardar umbral de stock mínimo en Firestore
        saveMinStockThresholdBtn.addEventListener('click', async () => {
            const newThreshold = parseInt(minStockThresholdInput.value);
            if (isNaN(newThreshold) || newThreshold < 0) {
                showMessageBox('Error', 'Por favor, ingrese un número válido para el umbral de stock.', 'error');
                return;
            }
            if (!window.db || !window.userId) {
                localStorage.setItem('minStockThreshold', newThreshold);
                showMessageBox('Configuración Guardada Localmente', `Umbral de stock mínimo actualizado a ${newThreshold} (sin conexión a la nube).`, 'info');
                minStockThreshold = newThreshold; // Actualizar variable local inmediatamente
                applyStockAlerts();
                return;
            }
            try {
                await setDoc(doc(window.db, getCollectionPath('settings'), 'appConfig'), { minStockThreshold: newThreshold }, { merge: true });
                showMessageBox('Configuración Guardada', `Umbral de stock mínimo actualizado a ${newThreshold} en la nube.`, 'success');
            } catch (e) {
                console.error("Error al guardar umbral de stock mínimo:", e);
                showMessageBox('Error', 'No se pudo guardar el umbral de stock en la nube.', 'error');
            }
        });

        // Guardar margen de ganancia por defecto en Firestore
        saveDefaultMarginBtn.addEventListener('click', async () => {
            const newMargin = parseFloat(defaultMarginInput.value);
            if (isNaN(newMargin) || newMargin < 0) {
                showMessageBox('Error', 'Por favor, ingrese un número válido para el margen de ganancia.', 'error');
                return;
            }
            if (!window.db || !window.userId) {
                localStorage.setItem('defaultProfitMargin', newMargin);
                showMessageBox('Configuración Guardada Localmente', `Margen de ganancia por defecto actualizado a ${newMargin}% (sin conexión a la nube).`, 'info');
                defaultProfitMargin = newMargin; // Actualizar variable local inmediatamente
                return;
            }
            try {
                await setDoc(doc(window.db, getCollectionPath('settings'), 'appConfig'), { defaultProfitMargin: newMargin }, { merge: true });
                showMessageBox('Configuración Guardada', `Margen de ganancia por defecto actualizado a ${newMargin}% en la nube.`, 'success');
            } catch (e) {
                console.error("Error al guardar margen por defecto:", e);
                showMessageBox('Error', 'No se pudo guardar el margen de ganancia en la nube.', 'error');
            }
        });


        // --- Lógica de Dashboard con Chart.js ---
        let salesChartInstance = null;
        let categorySalesChartInstance = null;

        function updateDashboardMetrics() {
            // Ventas del Día
            const today = new Date().toISOString().split('T')[0];
            const dailySales = salesData
                .filter(sale => sale.date === today)
                .reduce((sum, sale) => sum + sale.total, 0);
            dailySalesSpan.textContent = `$${dailySales.toFixed(2)}`;

            // Compras del Mes
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyPurchases = purchasesData
                .filter(purchase => {
                    const purchaseDate = new Date(purchase.date);
                    return purchaseDate.getMonth() === currentMonth && purchaseDate.getFullYear() === currentYear;
                })
                .reduce((sum, purchase) => sum + purchase.total, 0);
            monthlyPurchasesSpan.textContent = `$${monthlyPurchases.toFixed(2)}`;

            // Stock Valorizado
            const stockValue = productsData.reduce((sum, product) => sum + (product.stock * product.unitCost), 0);
            stockValueSpan.textContent = `$${stockValue.toFixed(2)}`;

            // Margen Promedio (simplificado)
            let totalRevenue = 0;
            let totalCostOfGoodsSold = 0;
            salesData.forEach(sale => {
                sale.items.forEach(item => {
                    const product = productsData.find(p => p.id === item.productId);
                    if (product) {
                        totalRevenue += item.finalPrice * item.quantity;
                        totalCostOfGoodsSold += product.unitCost * item.quantity;
                    }
                });
            });
            const averageMargin = totalRevenue > 0 ? ((totalRevenue - totalCostOfGoodsSold) / totalRevenue) * 100 : 0;
            averageMarginSpan.textContent = `${averageMargin.toFixed(2)}%`;
        }


        function renderSalesChart() {
            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            // Datos de ventas por mes (últimos 6 meses)
            const monthlySales = {};
            const today = new Date();
            for (let i = 0; i < 6; i++) {
                const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                monthlySales[monthKey] = 0;
            }

            salesData.forEach(sale => {
                const saleDate = new Date(sale.date);
                const monthKey = `${saleDate.getFullYear()}-${String(saleDate.getMonth() + 1).padStart(2, '0')}`;
                if (monthlySales.hasOwnProperty(monthKey)) {
                    monthlySales[monthKey] += sale.total;
                }
            });

            const labels = Object.keys(monthlySales).sort().map(key => {
                const [year, month] = key.split('-');
                return new Date(year, month - 1, 1).toLocaleDateString('es-ES', {
                    month: 'short'
                });
            });
            const data = Object.keys(monthlySales).sort().map(key => monthlySales[key]);


            salesChartInstance = new Chart(salesChartCanvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas Mensuales ($)',
                        data: data,
                        backgroundColor: 'rgba(74, 71, 163, 0.8)', // primary-accent con opacidad
                        borderColor: '#4A47A3', // primary-accent
                        borderWidth: 1,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#2C3E50' // text-dark
                            }
                        },
                        title: {
                            display: false,
                            text: 'Ventas Mensuales'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#7F8C8D' // text-secondary
                            },
                            grid: {
                                color: '#C0C7D1' // border-gray
                            }
                        },
                        x: {
                            ticks: {
                                color: '#7F8C8D' // text-secondary
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function renderCategorySalesChart() {
            if (categorySalesChartInstance) {
                categorySalesChartInstance.destroy();
            }

            const categorySales = {};
            salesData.forEach(sale => {
                sale.items.forEach(item => {
                    const product = productsData.find(p => p.id === item.productId);
                    if (product) {
                        categorySales[product.category] = (categorySales[product.category] || 0) + (item.quantity * item.finalPrice);
                    }
                });
            });

            const labels = Object.keys(categorySales);
            const data = Object.values(categorySales);
            const backgroundColors = [
                '#4A47A3', // primary-accent
                '#00C4B4', // secondary-accent
                '#FF7F50', // un color complementario
                '#A34A47', // otro color
                '#6A5ACD', // púrpura medio
                '#20B2AA' // verde azulado
            ];

            categorySalesChartInstance = new Chart(categorySalesChartCanvas.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length), // Usar colores disponibles
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#2C3E50' // text-dark
                            }
                        },
                        title: {
                            display: false,
                            text: 'Ventas por Categoría'
                        }
                    }
                }
            });
        }

        function updateTopSellingProducts() {
            topSellingProductsList.innerHTML = '';
            const productSales = {}; // { productId: totalQuantitySold }

            salesData.forEach(sale => {
                sale.items.forEach(item => {
                    productSales[item.productId] = (productSales[item.productId] || 0) + item.quantity;
                });
            });

            const sortedProducts = Object.entries(productSales)
                .sort(([, countA], [, countB]) => countB - countA)
                .slice(0, 5); // Top 5

            if (sortedProducts.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'No hay productos vendidos aún.';
                topSellingProductsList.appendChild(li);
            } else {
                sortedProducts.forEach(([productId, quantity]) => {
                    const product = productsData.find(p => p.id === productId);
                    if (product) {
                        const li = document.createElement('li');
                        li.textContent = `${product.name} (${quantity} unidades)`;
                        topSellingProductsList.appendChild(li);
                    }
                });
            }
        }

        function updateLowStockProducts() {
            lowStockProductsList.innerHTML = '';
            const lowStock = productsData.filter(p => p.stock <= minStockThreshold);

            if (lowStock.length === 0) {
                const li = document.createElement('li');
                li.textContent = 'Todos los productos tienen stock suficiente.';
                lowStockProductsList.appendChild(li);
            } else {
                lowStock.forEach(product => {
                    const li = document.createElement('li');
                    li.textContent = `${product.name} (Stock: ${product.stock})`;
                    lowStockProductsList.appendChild(li);
                });
            }
        }

        function updateLowStockWidget() {
            lowStockWidgetList.innerHTML = '';
            const lowStock = productsData.filter(p => p.stock <= minStockThreshold);

            if (lowStock.length === 0) {
                const li = document.createElement('li');
                li.classList.add('text-text-secondary', 'text-sm', 'text-center', 'py-2');
                li.textContent = 'No hay productos con bajo stock.';
                lowStockWidgetList.appendChild(li);
            } else {
                lowStock.forEach(product => {
                    const li = document.createElement('li');
                    li.textContent = `${product.name}: ${product.stock} unidades`;
                    lowStockWidgetList.appendChild(li);
                });
            }
        }

        function updateRecentSalesWidget() {
            recentSalesList.innerHTML = '';
            const sortedSales = [...salesData].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3);

            if (sortedSales.length === 0) {
                const li = document.createElement('li');
                li.classList.add('text-text-secondary', 'text-sm', 'text-center', 'py-2');
                li.textContent = 'No hay ventas recientes.';
                recentSalesList.appendChild(li);
            } else {
                sortedSales.forEach(sale => {
                    const li = document.createElement('li');
                    li.textContent = `Venta #${sale.id.substring(0, 5)}: $${sale.total.toFixed(2)} (${sale.client})`;
                    recentSalesList.appendChild(li);
                });
            }
        }

        function updateRecentPurchasesWidget() {
            recentPurchasesList.innerHTML = '';
            const sortedPurchases = [...purchasesData].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3);

            if (sortedPurchases.length === 0) {
                const li = document.createElement('li');
                li.classList.add('text-text-secondary', 'text-sm', 'text-center', 'py-2');
                li.textContent = 'No hay compras recientes.';
                recentPurchasesList.appendChild(li);
            } else {
                sortedPurchases.forEach(purchase => {
                    const li = document.createElement('li');
                    li.textContent = `Compra a ${purchase.supplier} (${purchase.date})`;
                    recentPurchasesList.appendChild(li);
                });
            }
        }


        // --- Lógica para Personalización de Columnas en Tablas (Simulado) ---
        customizeColumnsBtn.addEventListener('click', () => {
            showMessageBox('Personalizar Columnas', 'Aquí se podría implementar una interfaz para seleccionar qué columnas mostrar/ocultar y su orden.', 'info');
        });

        // --- Lógica para Etiquetas Personalizables para Impresión (Simulado) ---
        printLabelsBtn.addEventListener('click', () => {
            showMessageBox('Imprimir Etiquetas', 'Esta función generaría etiquetas de productos personalizables para impresión (ej. códigos de barra, precios, nombres).', 'info');
        });

        // --- Atajos de Teclado ---
        document.addEventListener('keydown', (e) => {
            // Ctrl + N para Nueva Venta
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault(); // Prevenir el comportamiento por defecto del navegador
                openNewSaleModalBtn.click();
            }
            // Ctrl + I para Inventario
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault(); // Prevenir el comportamiento por defecto del navegador
                // Simular clic en el enlace del módulo de inventario
                const inventarioLink = document.querySelector('.nav-item[data-section="inventario"]');
                if (inventarioLink) {
                    inventarioLink.click();
                }
            }
        });

        // --- Lógica de Tablas Dinámicas (Inventario, Compras, Ventas) ---

        /**
         * Rellena las opciones del filtro de categoría en el módulo de inventario.
         */
        function populateCategoryFilter() {
            const categories = [...new Set(productsData.map(p => p.category))].filter(Boolean); // Obtener categorías únicas y eliminar vacías
            filterCategorySelect.innerHTML = '<option value="">Todas</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                filterCategorySelect.appendChild(option);
            });
        }

        /**
         * Renderiza la tabla de productos con los datos filtrados y paginados.
         */
        function renderProductTable() {
            inventoryTableBody.innerHTML = ''; // Limpiar tabla

            const start = (currentProductPage - 1) * productsPerPage;
            const end = start + productsPerPage;
            const paginatedProducts = filteredProducts.slice(start, end);

            if (paginatedProducts.length === 0) {
                inventoryTableBody.innerHTML = `<tr><td colspan="7" class="py-3 px-4 text-center text-text-secondary">No hay productos que coincidan con los filtros.</td></tr>`;
                paginationInfo.textContent = `Mostrando 0 de ${filteredProducts.length} productos`;
                prevPageBtn.disabled = true;
                nextPageBtn.disabled = true;
                return;
            }

            paginatedProducts.forEach(product => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-border-gray', 'hover:bg-bg-lightest');
                row.innerHTML = `
                    <td class="py-3 px-4" data-label="Código:">${product.id}</td>
                    <td class="py-3 px-4" data-label="Nombre:">${product.name}</td>
                    <td class="py-3 px-4" data-label="Costo Unitario:">$${product.unitCost.toFixed(2)}</td>
                    <td class="py-3 px-4" data-label="Precio Sugerido:">$${product.suggestedPrice.toFixed(2)}</td>
                    <td class="py-3 px-4" data-label="Stock:">${product.stock}</td>
                    <td class="py-3 px-4" data-label="Categoría:">${product.category.charAt(0).toUpperCase() + product.category.slice(1)}</td>
                    <td class="py-3 px-4 flex space-x-2" data-label="Acciones:">
                        <button class="bg-secondary-accent text-white px-3 py-1 rounded-lg text-sm hover:bg-secondary-hover transition-colors duration-200 edit-product-btn" data-product-id="${product.id}" aria-label="Editar producto ${product.name}">Editar</button>
                        <button class="bg-error-red text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 delete-product-btn" data-product-id="${product.id}" aria-label="Eliminar producto ${product.name}">Eliminar</button>
                    </td>
                `;
                inventoryTableBody.appendChild(row);
            });

            applyStockAlerts(); // Aplicar alertas de stock después de renderizar

            // Actualizar información de paginación
            const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            paginationInfo.textContent = `Página ${currentProductPage} de ${totalPages} (${filteredProducts.length} productos)`;

            // Habilitar/deshabilitar botones de paginación
            prevPageBtn.disabled = currentProductPage === 1;
            nextPageBtn.disabled = currentProductPage === totalPages || totalPages === 0;

            // Añadir listeners para editar/eliminar (simulados)
            document.querySelectorAll('.edit-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    showMessageBox('Editar Producto', `Funcionalidad para editar el producto con ID: ${productId} (simulado).`, 'info');
                    // Aquí se abriría el modal de edición con los datos del producto
                });
            });

            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    showMessageBox(
                        'Confirmar Eliminación',
                        `¿Estás seguro de que quieres eliminar el producto con ID: ${productId}?`,
                        'error', // Usar tipo 'error' para confirmación de eliminación
                        async () => { // Esta función se ejecuta cuando se hace clic en 'Aceptar'
                            if (!window.db || !window.userId) {
                                showMessageBox('Error de Conexión', 'No se pudo eliminar el producto. Firebase no está conectado.', 'error');
                                return;
                            }
                            try {
                                await deleteDoc(doc(window.db, getCollectionPath('products'), productId));
                                showMessageBox('Producto Eliminado', `Producto con ID: ${productId} eliminado exitosamente de la nube.`, 'success');
                            } catch (error) {
                                console.error("Error al eliminar producto:", error);
                                showMessageBox('Error', `No se pudo eliminar el producto: ${error.message}`, 'error');
                            }
                        }
                    );
                });
            });
        }

        /**
         * Aplica filtros y búsqueda a los datos de productos y luego renderiza la tabla.
         */
        function applyProductFiltersAndRenderTable() {
            const searchTerm = productSearchInput.value.toLowerCase();
            const categoryFilter = filterCategorySelect.value;
            const priceMin = parseFloat(filterPriceMinInput.value) || 0;
            const priceMax = parseFloat(filterPriceMaxInput.value) || Infinity;

            filteredProducts = productsData.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                    product.id.toLowerCase().includes(searchTerm) ||
                    product.description.toLowerCase().includes(searchTerm);

                const matchesCategory = categoryFilter === '' || product.category === categoryFilter;

                const matchesPrice = product.suggestedPrice >= priceMin && product.suggestedPrice <= priceMax;

                return matchesSearch && matchesCategory && matchesPrice;
            });

            // Resetear a la primera página después de filtrar
            currentProductPage = 1;
            renderProductTable();
        }

        // Listeners para filtros de inventario
        productSearchInput.addEventListener('input', applyProductFiltersAndRenderTable);
        filterCategorySelect.addEventListener('change', applyProductFiltersAndRenderTable);
        filterPriceMinInput.addEventListener('input', applyProductFiltersAndRenderTable);
        filterPriceMaxInput.addEventListener('input', applyProductFiltersAndRenderTable);

        // Listeners para paginación de inventario
        prevPageBtn.addEventListener('click', () => {
            if (currentProductPage > 1) {
                currentProductPage--;
                renderProductTable();
            }
        });
        nextPageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
            if (currentProductPage < totalPages) {
                currentProductPage++;
                renderProductTable();
            }
        });

        // Ordenamiento de tabla de inventario
        inventoryTableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortBy = header.dataset.sort;
                const isAsc = header.classList.contains('asc');

                // Limpiar clases de ordenamiento de otros encabezados
                inventoryTableHeaders.forEach(h => {
                    h.classList.remove('asc', 'desc');
                    const icon = h.querySelector('i');
                    if (icon) icon.className = 'fas fa-sort text-xs ml-1';
                });

                // Aplicar ordenamiento
                filteredProducts.sort((a, b) => {
                    let valA = a[sortBy];
                    let valB = b[sortBy];

                    if (typeof valA === 'string') {
                        return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    }
                    return isAsc ? valA - valB : valB - valA;
                });

                // Actualizar clase del encabezado
                header.classList.add(isAsc ? 'desc' : 'asc');
                const icon = header.querySelector('i');
                if (icon) icon.className = `fas fa-sort-${isAsc ? 'down' : 'up'} text-xs ml-1`;

                currentProductPage = 1; // Volver a la primera página después de ordenar
                renderProductTable();
            });
        });


        /**
         * Renderiza la tabla de compras con los datos filtrados y paginados.
         */
        function renderPurchaseTable() {
            purchasesTableBody.innerHTML = '';

            const start = (currentPurchasePage - 1) * purchasesPerPage;
            const end = start + purchasesPerPage;
            const paginatedPurchases = filteredPurchases.slice(start, end);

            if (paginatedPurchases.length === 0) {
                purchasesTableBody.innerHTML = `<tr><td colspan="5" class="py-3 px-4 text-center text-text-secondary">No hay compras que coincidan con los filtros.</td></tr>`;
                purchasePaginationInfo.textContent = `Mostrando 0 de ${filteredPurchases.length} compras`;
                prevPurchasePageBtn.disabled = true;
                nextPurchasePageBtn.disabled = true;
                return;
            }

            paginatedPurchases.forEach(purchase => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-border-gray', 'hover:bg-bg-lightest');
                row.innerHTML = `
                    <td class="py-3 px-4">${purchase.date}</td>
                    <td class="py-3 px-4">${purchase.supplier}</td>
                    <td class="py-3 px-4">$${purchase.total.toFixed(2)}</td>
                    <td class="py-3 px-4">${purchase.items.length}</td>
                    <td class="py-3 px-4">
                        <button class="bg-text-secondary text-white px-3 py-1 rounded-lg text-sm hover:bg-gray-700 transition-colors duration-200 view-purchase-detail-btn" data-purchase-id="${purchase.id}" aria-label="Ver detalle de compra ${purchase.id}">Ver Detalle</button>
                    </td>
                `;
                purchasesTableBody.appendChild(row);
            });

            const totalPages = Math.ceil(filteredPurchases.length / purchasesPerPage);
            purchasePaginationInfo.textContent = `Página ${currentPurchasePage} de ${totalPages} (${filteredPurchases.length} compras)`;

            prevPurchasePageBtn.disabled = currentPurchasePage === 1;
            nextPurchasePageBtn.disabled = currentPurchasePage === totalPages || totalPages === 0;

            document.querySelectorAll('.view-purchase-detail-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const purchaseId = e.target.dataset.purchaseId;
                    const purchase = purchasesData.find(p => p.id === purchaseId);
                    if (purchase) {
                        let detailContent = `
                            <p><strong>Fecha:</strong> ${purchase.date}</p>
                            <p><strong>Proveedor:</strong> ${purchase.supplier}</p>
                            <p><strong>Total:</strong> $${purchase.total.toFixed(2)}</p>
                            <h4 class="font-semibold mt-4 mb-2">Productos:</h4>
                            <ul>
                        `;
                        purchase.items.forEach(item => {
                            detailContent += `<li>${item.name} (x${item.quantity}) - $${item.unitCost.toFixed(2)} c/u</li>`;
                        });
                        detailContent += `</ul>`;
                        showMessageBox('Detalle de Compra', detailContent, 'info');
                    }
                });
            });
        }

        function applyPurchaseFiltersAndRenderTable() {
            const searchTerm = purchaseSearchInput.value.toLowerCase();

            filteredPurchases = purchasesData.filter(purchase => {
                const matchesSearch = purchase.supplier.toLowerCase().includes(searchTerm) ||
                    purchase.date.includes(searchTerm);
                return matchesSearch;
            });

            currentPurchasePage = 1;
            renderPurchaseTable();
        }

        purchaseSearchInput.addEventListener('input', applyPurchaseFiltersAndRenderTable);
        prevPurchasePageBtn.addEventListener('click', () => {
            if (currentPurchasePage > 1) {
                currentPurchasePage--;
                renderPurchaseTable();
            }
        });
        nextPurchasePageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredPurchases.length / purchasesPerPage);
            if (currentPurchasePage < totalPages) {
                currentPurchasePage++;
                renderPurchaseTable();
            }
        });

        // Ordenamiento de tabla de compras
        purchaseTableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortBy = header.dataset.sort;
                const isAsc = header.classList.contains('asc');

                purchaseTableHeaders.forEach(h => {
                    h.classList.remove('asc', 'desc');
                    const icon = h.querySelector('i');
                    if (icon) icon.className = 'fas fa-sort text-xs ml-1';
                });

                filteredPurchases.sort((a, b) => {
                    let valA = a[sortBy];
                    let valB = b[sortBy];

                    if (sortBy === 'date') {
                        valA = new Date(valA);
                        valB = new Date(valB);
                    } else if (typeof valA === 'string') {
                        return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    }
                    return isAsc ? valA - valB : valB - valA;
                });

                header.classList.add(isAsc ? 'desc' : 'asc');
                const icon = header.querySelector('i');
                if (icon) icon.className = `fas fa-sort-${isAsc ? 'down' : 'up'} text-xs ml-1`;

                currentPurchasePage = 1;
                renderPurchaseTable();
            });
        });


        /**
         * Renderiza la tabla de ventas con los datos filtrados y paginados.
         */
        function renderSaleTable() {
            salesTableBody.innerHTML = '';

            const start = (currentSalePage - 1) * salesPerPage;
            const end = start + salesPerPage;
            const paginatedSales = filteredSales.slice(start, end);

            if (paginatedSales.length === 0) {
                salesTableBody.innerHTML = `<tr><td colspan="5" class="py-3 px-4 text-center text-text-secondary">No hay ventas que coincidan con los filtros.</td></tr>`;
                salePaginationInfo.textContent = `Mostrando 0 de ${filteredSales.length} ventas`;
                prevSalePageBtn.disabled = true;
                nextSalePageBtn.disabled = true;
                return;
            }

            paginatedSales.forEach(sale => {
                const row = document.createElement('tr');
                row.classList.add('border-b', 'border-border-gray', 'hover:bg-bg-lightest');
                row.innerHTML = `
                    <td class="py-3 px-4">${sale.date}</td>
                    <td class="py-3 px-4">${sale.client}</td>
                    <td class="py-3 px-4">$${sale.total.toFixed(2)}</td>
                    <td class="py-3 px-4">${sale.items.length}</td>
                    <td class="py-3 px-4">
                        <button class="bg-text-secondary text-white px-3 py-1 rounded-lg text-sm hover:bg-gray-700 transition-colors duration-200 view-sale-detail-btn" data-sale-id="${sale.id}" aria-label="Ver detalle de venta ${sale.id}">Ver Detalle</button>
                    </td>
                `;
                salesTableBody.appendChild(row);
            });

            const totalPages = Math.ceil(filteredSales.length / salesPerPage);
            salePaginationInfo.textContent = `Página ${currentSalePage} de ${totalPages} (${filteredSales.length} ventas)`;

            prevSalePageBtn.disabled = currentSalePage === 1;
            nextSalePageBtn.disabled = currentSalePage === totalPages || totalPages === 0;

            document.querySelectorAll('.view-sale-detail-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const saleId = e.target.dataset.saleId;
                    const sale = salesData.find(s => s.id === saleId);
                    if (sale) {
                        let detailContent = `
                            <p><strong>Fecha:</strong> ${sale.date}</p>
                            <p><strong>Cliente:</strong> ${sale.client}</p>
                            <p><strong>Método de Pago:</strong> ${sale.paymentMethod}</p>
                            <p><strong>Total:</strong> $${sale.total.toFixed(2)}</p>
                            <h4 class="font-semibold mt-4 mb-2">Productos:</h4>
                            <ul>
                        `;
                        sale.items.forEach(item => {
                            detailContent += `<li>${item.name} (x${item.quantity}) - $${item.finalPrice.toFixed(2)} c/u</li>`;
                        });
                        detailContent += `</ul>`;
                        showMessageBox('Detalle de Venta', detailContent, 'info');
                    }
                });
            });
        }

        function applySaleFiltersAndRenderTable() {
            const searchTerm = saleSearchInput.value.toLowerCase();

            filteredSales = salesData.filter(sale => {
                const matchesSearch = sale.client.toLowerCase().includes(searchTerm) ||
                    sale.date.includes(searchTerm);
                return matchesSearch;
            });

            currentSalePage = 1;
            renderSaleTable();
        }

        saleSearchInput.addEventListener('input', applySaleFiltersAndRenderTable);
        prevSalePageBtn.addEventListener('click', () => {
            if (currentSalePage > 1) {
                currentSalePage--;
                renderSaleTable();
            }
        });
        nextSalePageBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(filteredSales.length / salesPerPage);
            if (currentSalePage < totalPages) {
                currentSalePage++;
                renderSaleTable();
            }
        });

        // Ordenamiento de tabla de ventas
        saleTableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortBy = header.dataset.sort;
                const isAsc = header.classList.contains('asc');

                saleTableHeaders.forEach(h => {
                    h.classList.remove('asc', 'desc');
                    const icon = h.querySelector('i');
                    if (icon) icon.className = 'fas fa-sort text-xs ml-1';
                });

                filteredSales.sort((a, b) => {
                    let valA = a[sortBy];
                    let valB = b[sortBy];

                    if (sortBy === 'date') {
                        valA = new Date(valA);
                        valB = new Date(valB);
                    } else if (typeof valA === 'string') {
                        return isAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                    }
                    return isAsc ? valA - valB : valB - valA;
                });

                header.classList.add(isAsc ? 'desc' : 'asc');
                const icon = header.querySelector('i');
                if (icon) icon.className = `fas fa-sort-${isAsc ? 'down' : 'up'} text-xs ml-1`;

                currentSalePage = 1;
                renderSaleTable();
            });
        });


        // --- Función de inicialización principal de la aplicación ---
        function initApp() {
            updateDebeIndicator(); // Llamar al cargar para establecer el estado inicial del indicador "Debe"
            defaultMarginInput.value = defaultProfitMargin; // Cargar el valor guardado en el input
            minStockThresholdInput.value = minStockThreshold; // Cargar el valor guardado en el input
            switchModule('inventario'); // Asegurarse de que Inventario sea el módulo activo al cargar
            // El resto de las actualizaciones son manejadas por los listeners de Firestore
        }

        // La función initApp() se llama una vez que Firebase se inicializa y autentica.
    </script>
</body>

</html>